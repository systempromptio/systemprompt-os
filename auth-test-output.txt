
> @systemprompt/os@0.1.0 test
> vitest run tests/e2e/02-server-auth.e2e.spec.ts 2


 RUN  v2.1.9 /var/www/html/systemprompt-os

 ❯ tests/e2e/modules/core/heartbeat/heartbeat-e2e.spec.ts (0 test)
 ❯ tests/unit/server/external/rest/oauth2/register.spec.ts (0 test)
 ❯ tests/unit/modules/core/auth/providers/core/oauth2.spec.ts (13 tests | 3 failed) 34ms
   × GenericOAuth2Provider > exchangeCodeForTokens > exchanges authorization code for tokens 13ms
     → expected { …(4) } to deeply equal { …(4) }
   × GenericOAuth2Provider > getUserInfo > fetches user info with access token 4ms
     → expected { id: '123456', …(5) } to deeply equal { id: '123456', …(5) }
   × GenericOAuth2Provider > refreshAccessToken > refreshes access token using refresh token 2ms
     → expected { …(3) } to deeply equal { …(3) }
 ❯ tests/unit/server/external/auth/providers/generic-oauth2.spec.ts (53 tests | 36 failed) 64ms
   × GenericOAuth2Provider > Constructor > should initialize OAuth2 provider with correct properties 14ms
     → expected 'oidc' to be 'oauth2' // Object.is equality
   × GenericOAuth2Provider > Constructor > should set default scope when not provided 3ms
     → expected 'email profile' to be 'openid email profile' // Object.is equality
   × GenericOAuth2Provider > Constructor > should set default scope when scope is null 1ms
     → expected 'email profile' to be 'openid email profile' // Object.is equality
   × GenericOAuth2Provider > Constructor > should set default scope when scope is undefined 1ms
     → expected 'email profile' to be 'openid email profile' // Object.is equality
   × GenericOAuth2Provider > getAuthorizationUrl > should include nonce for OIDC provider when provided 2ms
     → expected null to be 'test-nonce' // Object.is equality
   × GenericOAuth2Provider > exchangeCodeForToken > should successfully exchange code for tokens 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > exchangeCodeForToken > should handle missing client secret gracefully 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > exchangeCodeForToken > should handle null client secret gracefully 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > exchangeCodeForToken > should throw error when token exchange fails 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > exchangeCodeForToken > should throw error when fetch throws 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should successfully retrieve user info with default mapping 3ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should use custom userinfo mapping when provided 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should fallback to standard fields when custom mapping returns undefined 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should fallback to id field when sub is not available 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should return empty string for id when no fallbacks are available 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should handle nested object paths in mapping 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should handle deep nested paths that do not exist 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should handle null values in nested objects 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should throw error when userinfo request fails 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getUserInfo > should throw error when fetch throws 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > refreshTokens > should successfully refresh tokens 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > refreshTokens > should handle missing client secret gracefully 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > refreshTokens > should handle null client secret gracefully 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > refreshTokens > should throw error when token refresh fails 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > refreshTokens > should throw error when fetch throws 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > OIDC-specific functionality > should support OIDC-specific features 2ms
     → expected null to be 'nonce-value' // Object.is equality
   × GenericOAuth2Provider > OIDC-specific functionality > should include nonce in authorization URL for OIDC providers 1ms
     → expected null to be 'test-nonce' // Object.is equality
   × GenericOAuth2Provider > Edge cases and error scenarios > should handle malformed JSON responses in token exchange 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > Edge cases and error scenarios > should handle malformed JSON responses in token refresh 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > Edge cases and error scenarios > should handle malformed JSON responses in getUserInfo 3ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getNestedValue functionality > should handle primitive values in nested objects 1ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getNestedValue functionality > should handle arrays in nested paths 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getNestedValue functionality > should return undefined for out-of-bounds array access 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getNestedValue functionality > should handle empty path segments 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getNestedValue functionality > should handle paths with multiple dots 0ms
     → fetchMock is not defined
   × GenericOAuth2Provider > getNestedValue functionality > should handle circular references gracefully 0ms
     → fetchMock is not defined
 ❯ tests/unit/server/external/rest/oauth2/userinfo.spec.ts (33 tests | 32 failed) 63ms
   × UserInfoEndpoint > getUserInfo > returns 401 when user is not authenticated 10ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > returns 400 when user is not found in database 2ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > returns basic user info with openid scope only 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles undefined scope 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles empty string scope 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > includes profile information when profile scope is present 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > includes email information when email scope is present 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > includes agent information when agent scope is present 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > includes all information when all scopes are present 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles user without name field 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles user without avatarUrl field 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles email without @ symbol 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles email with multiple @ symbols 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles multiple scopes separated by spaces 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles different user ID 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > ignores unknown scopes 3ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > only includes scope-specific data in response 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > tests all conditional branches in scope checking 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > verifies AuthRepository singleton is called 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles empty email parts correctly 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > tests email_verified is always true 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > tests agent_id generation format 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > ensures profile scope conditional checks work correctly 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > ensures email scope conditional checks work correctly 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > ensures agent scope conditional checks work correctly 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles database errors gracefully 12ms
     → expected [Function] to throw error including 'Database connection failed' but got 'Cannot read properties of undefined (…'
   × UserInfoEndpoint > getUserInfo > handles user with empty email string 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles user with null name field 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles user with null avatarUrl field 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > verifies email_verified undefined check branch 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles scope with mixed case 1ms
     → Cannot read properties of undefined (reading 'authorization')
   × UserInfoEndpoint > getUserInfo > handles scope string with trailing/leading spaces 1ms
     → Cannot read properties of undefined (reading 'authorization')
 ❯ tests/unit/server/external/rest/oauth2/errors.spec.ts (18 tests | 18 failed) 21ms
   × OAuth2 Errors > OAuth2ErrorType Enum > should have correct error type values 6ms
     → Cannot read properties of undefined (reading 'InvalidRequest')
   × OAuth2 Errors > OAuth2Error Class > should create error with type and description 1ms
     → Cannot read properties of undefined (reading 'InvalidRequest')
   × OAuth2 Errors > OAuth2Error Class > should use error type as message when description is not provided 1ms
     → Cannot read properties of undefined (reading 'InvalidGrant')
   × OAuth2 Errors > OAuth2Error Class > should accept custom error code 1ms
     → Cannot read properties of undefined (reading 'InvalidClient')
   × OAuth2 Errors > OAuth2Error Class > should include error URI when provided 0ms
     → Cannot read properties of undefined (reading 'InvalidScope')
   × OAuth2 Errors > OAuth2Error Class > toJSON > should serialize to OAuth2ErrorResponse format 1ms
     → Cannot read properties of undefined (reading 'InvalidRequest')
   × OAuth2 Errors > OAuth2Error Class > toJSON > should omit undefined fields 1ms
     → Cannot read properties of undefined (reading 'ServerError')
   × OAuth2 Errors > OAuth2Error Class > toJSON > should include error_uri when present 1ms
     → Cannot read properties of undefined (reading 'InvalidScope')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create InvalidRequest error 1ms
     → Cannot read properties of undefined (reading 'InvalidRequest')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create InvalidClient error with 401 code 1ms
     → Cannot read properties of undefined (reading 'InvalidClient')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create InvalidGrant error 1ms
     → Cannot read properties of undefined (reading 'InvalidGrant')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create UnauthorizedClient error 1ms
     → Cannot read properties of undefined (reading 'UnauthorizedClient')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create UnsupportedGrantType error 1ms
     → Cannot read properties of undefined (reading 'UnsupportedGrantType')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create UnsupportedResponseType error 1ms
     → Cannot read properties of undefined (reading 'UnsupportedResponseType')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create InvalidScope error 1ms
     → Cannot read properties of undefined (reading 'InvalidScope')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create AccessDenied error 1ms
     → Cannot read properties of undefined (reading 'AccessDenied')
   × OAuth2 Errors > OAuth2Error Class > Static factory methods > should create ServerError with 500 code 1ms
     → Cannot read properties of undefined (reading 'ServerError')
   × OAuth2 Errors > OAuth2Error Class > should be instanceof Error 1ms
     → Cannot read properties of undefined (reading 'InvalidRequest')
 ❯ tests/unit/server/external/rest/oauth2/well-known.spec.ts (28 tests | 15 failed) 76ms
   × WellKnownEndpoint > constructor > should create an instance with default publicKeyJWK as null 14ms
     → expected { kty: 'RSA', …(5) } to be null
   × WellKnownEndpoint > getOpenIDConfiguration > should return OpenID configuration from oauth2ConfigService 2ms
     → endpoint.getOpenIDConfiguration is not a function
   × WellKnownEndpoint > getOpenIDConfiguration > should handle when authModule throws an error 10ms
     → expected [Function] to throw error including 'Auth module not loaded' but got 'endpoint.getOpenIDConfiguration is no…'
   × WellKnownEndpoint > getOpenIDConfiguration > should handle when oauth2ConfigService throws an error 4ms
     → expected [Function] to throw error including 'OAuth2 config service error' but got 'endpoint.getOpenIDConfiguration is no…'
   × WellKnownEndpoint > getOpenIDConfiguration > should handle when getOpenIDConfiguration throws an error 3ms
     → expected [Function] to throw error including 'Configuration retrieval error' but got 'endpoint.getOpenIDConfiguration is no…'
   × WellKnownEndpoint > getOpenIDConfiguration > should work with different request objects 2ms
     → endpoint.getOpenIDConfiguration is not a function
   × WellKnownEndpoint > getOpenIDConfiguration > should handle null/undefined config gracefully 1ms
     → endpoint.getOpenIDConfiguration is not a function
   × WellKnownEndpoint > getJWKS > should return 500 error when publicKeyJWK is null 2ms
     → expected { kty: 'RSA', …(5) } to be null
   × WellKnownEndpoint > OpenIDConfiguration interface > should accept valid OpenIDConfiguration objects 1ms
     → endpoint.getOpenIDConfiguration is not a function
   × WellKnownEndpoint > OpenIDConfiguration interface > should handle minimal OpenIDConfiguration objects 1ms
     → endpoint.getOpenIDConfiguration is not a function
   × WellKnownEndpoint > Edge cases and error scenarios > should handle when response.json throws an error 2ms
     → expected [Function] to throw error including 'JSON serialization error' but got 'endpoint.getOpenIDConfiguration is no…'
   × WellKnownEndpoint > Edge cases and error scenarios > should handle when response.status throws an error in getJWKS 2ms
     → promise resolved "undefined" instead of rejecting
   × WellKnownEndpoint > Edge cases and error scenarios > should handle concurrent calls to getOpenIDConfiguration 3ms
     → endpoint.getOpenIDConfiguration is not a function
   × WellKnownEndpoint > Property access and method binding > should maintain method binding when extracted 1ms
     → extractedMethod is not a function
   × WellKnownEndpoint > Property access and method binding > should handle this context correctly in arrow functions 1ms
     → Cannot read properties of undefined (reading 'bind')
 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts (18 tests | 13 failed) 62ms
   × OAuth2 Authorize Endpoint > getAuthorize > without provider parameter > should display authorization consent form with valid parameters 23ms
     → expected "spy" to be called with arguments: [ StringContaining "provider=github" ]

Received: 

  1st spy call:

  Array [
-   StringContaining "provider=github",
+   "
+     <!DOCTYPE html>
+     <html>
+     <head>
+       <title>Sign In - systemprompt-os</title>
+       <style>
+     body { font-family: system-ui; max-width: 600px; margin: 50px auto; 
+       padding: 20px; background: #f5f5f5; }
+     .container { background: white; border-radius: 8px; padding: 40px; 
+       box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
+     h1 { color: #333; text-align: center; margin-bottom: 30px; }
+     .client { background: #f8f9fa; padding: 15px; border-radius: 4px; 
+       margin: 20px 0; }
+     .scopes { margin: 20px 0; }
+     .scope-item { margin: 10px 0; color: #666; }
+     .provider-list { margin: 30px 0; }
+     .provider-button { 
+       display: flex; align-items: center; justify-content: center;
+       width: 100%; padding: 12px 20px; margin: 10px 0;
+       border: 1px solid #ddd; border-radius: 6px;
+       background: white; color: #333;
+       text-decoration: none; font-size: 16px;
+       transition: all 0.2s;
+     }
+     .provider-button:hover { 
+       background: #f8f9fa; border-color: #999;
+       transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
+     }
+     .provider-google { border-color: #4285f4; color: #4285f4; }
+     .provider-google:hover { background: #f0f7ff; }
+     .provider-github { border-color: #333; color: #333; }
+     .provider-github:hover { background: #f6f8fa; }
+     .cancel { text-align: center; margin-top: 20px; }
+     .cancel a { color: #666; text-decoration: none; }
+     .cancel a:hover { text-decoration: underline; }
+   </style>
+     </head>
+     <body>
+       <div class=\"container\">
+         <h1>Sign in to continue</h1>
+         <div class=\"client\">
+           <strong>Application:</strong> test-client<br>
+           <small style=\"color: #666;\">
+             This application is requesting access to your account
+           </small>
+         </div>
+         <div class=\"scopes\">
+           <strong>Requested permissions:</strong>
+           <ul>
+             <li class=\"scope-item\">read</li><li class=\"scope-item\">write</li>
+           </ul>
+         </div>
+         <div class=\"provider-list\">
+           <h3 style=\"text-align: center; margin-bottom: 20px;\">
+             Choose how to sign in:
+           </h3>
+           
+     <a href=\"/oauth2/authorize?responseType=code&clientId=test-client&redirectUri=http%3A%2F%2Flocalhost%3A3000%2Fcallback&scope=read+write&provider=google&state=client-state\" 
+        class=\"provider-button provider-google\">
+       🔵 Sign in with Google
+     </a>
+   
+         </div>
+         <div class=\"cancel\">
+           <a href=\"http://localhost:3000/callback?error=access_denied&state=client-state\">Cancel</a>
+         </div>
+       </div>
+     </body>
+     </html>
+   ",
  ]


Number of calls: 1

   × OAuth2 Authorize Endpoint > getAuthorize > without provider parameter > should handle missing required parameters 6ms
     → expected "spy" to be called with arguments: [ { error: 'invalid_request', …(1) } ]

Received: 

  1st spy call:

  Array [
    Object {
      "error": "invalid_request",
-     "message": Any<String>,
+     "error_description": "response_type is required",
    },
  ]


Number of calls: 1

   × OAuth2 Authorize Endpoint > getAuthorize > without provider parameter > should handle invalid responseType 3ms
     → expected "spy" to be called with arguments: [ { error: 'invalid_request', …(1) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "error": "invalid_request",
-     "message": Any<String>,
+     "error": "unsupported_response_type",
+     "error_description": "Unsupported response_type",
    },
  ]


Number of calls: 1

   × OAuth2 Authorize Endpoint > getAuthorize > with provider parameter > should redirect to Google provider with state 2ms
     → expected "spy" to be called with arguments: [ Any<String> ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > getAuthorize > with provider parameter > should handle case insensitive provider names 1ms
     → expected "spy" to be called with arguments: [ 'google' ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > getAuthorize > with provider parameter > should handle unknown provider 2ms
     → expected "spy" to be called with arguments: [ { error: 'server_error', …(1) } ]

Received: 

  1st spy call:

  Array [
    Object {
      "error": "server_error",
-     "message": "Unknown provider: unknown",
+     "error_description": "Unknown provider: unknown",
    },
  ]


Number of calls: 1

   × OAuth2 Authorize Endpoint > getAuthorize > error handling > should handle server errors during HTML generation 3ms
     → expected "spy" to be called with arguments: [ 500 ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > getAuthorize > error handling > should handle non-Error exceptions 2ms
     → expected "spy" to be called with arguments: [ 500 ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > postAuthorize > authorization denial > should handle denial with missing redirectUri 2ms
     → expected "spy" to be called with arguments: [ { error: 'server_error', …(1) } ]

Received: 

  1st spy call:

  Array [
    Object {
      "error": "server_error",
-     "message": "Internal server error",
+     "error_description": "Internal server error",
    },
  ]


Number of calls: 1

   × OAuth2 Authorize Endpoint > postAuthorize > authorization approval > should handle authorization approval with valid user 2ms
     → expected "spy" to be called with arguments: [ { clientId: 'test-client', …(5) } ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > postAuthorize > authorization approval > should handle missing user authentication 2ms
     → expected "spy" to be called with arguments: [ { error: 'server_error', …(1) } ]

Received: 

  1st spy call:

  Array [
    Object {
      "error": "server_error",
-     "message": "Internal server error",
+     "error_description": "Internal server error",
    },
  ]


Number of calls: 1

   × OAuth2 Authorize Endpoint > handleProviderCallback > successful callback handling > should handle provider callback with authorization code 2ms
     → expected "spy" to be called with arguments: [ 'provider-auth-code' ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > handleProviderCallback > error handling > should handle provider callback error 1ms
     → expected "spy" to be called with arguments: [ StringContaining{…} ]

Received: 

  1st spy call:

  Array [
-   StringContaining "User denied access",
+   "
+     <html>
+     <body>
+       <h1>Authentication Failed</h1>
+       <p>Error: access_denied</p>
+       
+     </body>
+     </html>
+   ",
  ]


Number of calls: 1

 ❯ tests/unit/server/external/rest/oauth2/index.spec.ts (6 tests | 3 failed) 28ms
   × setupOAuth2Routes > should initialize all endpoint handlers with correct parameters 12ms
     → expected "spy" to be called with arguments: [ 'https://example.com' ]

Received: 

  1st spy call:

- Array [
-   "https://example.com",
- ]
+ Array []


Number of calls: 1

   × setupOAuth2Routes > should use authMiddleware for protected routes 3ms
     → expected [Function authMiddleware] to be [Function spy] // Object.is equality
   × setupOAuth2Routes > should work with different baseUrl formats 1ms
     → expected "spy" to be called with arguments: [ 'http://localhost:3000' ]

Received: 

  1st spy call:

- Array [
-   "http://localhost:3000",
- ]
+ Array []


Number of calls: 1

 ❯ tests/unit/server/external/rest/oauth2/default-client.spec.ts (15 tests | 2 failed) 180ms
   × getDefaultOAuthClient > should create new default client when none exists 58ms
     → expected "spy" to be called with arguments: [ { …(7) } ]

Received: 

  1st spy call:

  Array [
    Object {
      "client_id": "default-web-client",
      "client_name": "SystemPrompt Web Client",
      "grant_types": Array [
        "authorization_code",
        "refresh_token",
      ],
      "redirect_uris": Array [
        "https://example.com/oauth2/callback/google",
        "https://example.com/oauth2/callback/github",
        "https://example.com/auth/callback",
      ],
      "response_types": Array [
        "code",
      ],
-     "scope": "openid profile email",
+     "scope": "profile email",
      "token_endpoint_auth_method": "none",
    },
  ]


Number of calls: 1

   × getDefaultOAuthClient > should create new client with all required registration fields 4ms
     → expected "spy" to be called with arguments: [ { …(7) } ]

Received: 

  1st spy call:

  Array [
    Object {
      "client_id": "default-web-client",
      "client_name": "SystemPrompt Web Client",
      "grant_types": Array [
        "authorization_code",
        "refresh_token",
      ],
      "redirect_uris": Array [
        "https://example.com/oauth2/callback/google",
        "https://example.com/oauth2/callback/github",
        "https://example.com/auth/callback",
      ],
      "response_types": Array [
        "code",
      ],
-     "scope": "openid profile email",
+     "scope": "profile email",
      "token_endpoint_auth_method": "none",
    },
  ]


Number of calls: 1

 ❯ tests/e2e/02-server-auth.e2e.spec.ts (19 tests | 12 failed) 131ms
   × [02] Server Auth Domain > OAuth2 Authorization Flow > should reject authorization request without client_id 16ms
     → expected { error: 'invalid_request', …(1) } to have property "error_description"
   × [02] Server Auth Domain > OAuth2 Authorization Flow > should reject authorization request without response_type 8ms
     → the given combination of arguments (undefined and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string
   × [02] Server Auth Domain > OAuth2 Authorization Flow > should reject unsupported response_type 8ms
     → expected { error: 'invalid_request', …(1) } to have property "error" with value 'unsupported_response_type'
   × [02] Server Auth Domain > OAuth2 Authorization Flow > should show IDP selection for valid authorization request 6ms
     → expected 400 to be 200 // Object.is equality
   × [02] Server Auth Domain > OAuth2 Authorization Flow > should handle IDP selection and redirect 7ms
     → expected 400 to be 302 // Object.is equality
   × [02] Server Auth Domain > OAuth2 Token Endpoint > should reject token request without grant_type 7ms
     → expected '[\n  {\n    "expected": "\'authorizat…' to contain 'grant_type'
   × [02] Server Auth Domain > OAuth2 Token Endpoint > should reject unsupported grant_type 5ms
     → expected { error: 'invalid_request', …(1) } to have property "error" with value 'unsupported_grant_type'
   × [02] Server Auth Domain > OAuth2 Token Endpoint > should reject invalid authorization code 5ms
     → expected { error: 'invalid_request', …(1) } to have property "error" with value 'invalid_grant'
   × [02] Server Auth Domain > OAuth2 Token Endpoint > should handle refresh_token grant type 7ms
     → expected { error: 'invalid_request', …(1) } to have property "error" with value 'invalid_grant'
   × [02] Server Auth Domain > Authorization Callback > should handle OAuth callback with error 4ms
     → expected 302 to be 400 // Object.is equality
   × [02] Server Auth Domain > Authorization Callback > should validate state parameter in callback 4ms
     → expected 302 to be 400 // Object.is equality
   × [02] Server Auth Domain > Security Headers > should include security headers on auth endpoints 4ms
     → expected { 'x-powered-by': 'Express', …(8) } to have property "x-frame-options" with value 'DENY'
 ❯ tests/e2e/mcp-tool-api.spec.ts (7 tests | 7 failed) 32ms
   × MCP Tool API E2E Tests > Tool Listing Flow > should show different tools based on user role 12ms
     → Logger initialization failed: Logger not initialized
   × MCP Tool API E2E Tests > Tool Execution Flow > should enforce permissions throughout tool execution 3ms
     → Logger initialization failed: Logger not initialized
   × MCP Tool API E2E Tests > Tool Execution Flow > should handle tool errors gracefully 7ms
     → expected [Function] to throw error including 'Unknown tool: nonexistent-tool' but got 'Logger initialization failed: Logger …'
   × MCP Tool API E2E Tests > Audit Trail > should create comprehensive audit logs 1ms
     → Logger initialization failed: Logger not initialized
   × MCP Tool API E2E Tests > Performance > should handle concurrent requests efficiently 5ms
     → Target cannot be null or undefined.
   × MCP Tool API E2E Tests > Integration with Permission System > should respect custom permissions 1ms
     → Logger initialization failed: Logger not initialized
   × MCP Tool API E2E Tests > Error Recovery > should handle and log various error conditions 2ms
     → expected 'Logger initialization failed: Logger …' to contain 'Session ID is required'
 ❯ tests/unit/server/external/rest/oauth2/token.spec.ts (0 test)
 ❯ tests/unit/server/external/rest/oauth2/protected-resource.spec.ts (0 test)
 ❯ tests/unit/server/external/rest/oauth2/authorization-server.spec.ts (16 tests | 15 failed) 29ms
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should successfully return authorization server metadata 5ms
     → expected "spy" to be called 1 times, but got 0 times
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should handle different metadata configurations 5ms
     → expected "spy" to be called with arguments: [ { …(9) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "authorization_endpoint": "https://alternative.example.com/auth",
-     "grant_types_supported": Array [
-       "authorization_code",
-     ],
-     "issuer": "https://alternative.example.com",
-     "jwks_uri": "https://alternative.example.com/jwks",
-     "response_types_supported": Array [
-       "code",
-     ],
-     "scopes_supported": Array [
-       "openid",
-       "profile",
-     ],
-     "token_endpoint": "https://alternative.example.com/token",
-     "token_endpoint_auth_methods_supported": Array [
-       "client_secret_basic",
-     ],
-     "userinfo_endpoint": "https://alternative.example.com/userinfo",
+     "error": "Method not allowed",
    },
  ]


Number of calls: 1

   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should handle metadata with minimal required fields only 1ms
     → expected "spy" to be called with arguments: [ { …(5) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "authorization_endpoint": "https://minimal.example.com/oauth2/authorize",
-     "issuer": "https://minimal.example.com",
-     "jwks_uri": "https://minimal.example.com/.well-known/jwks.json",
-     "response_types_supported": Array [
-       "code",
-     ],
-     "token_endpoint": "https://minimal.example.com/oauth2/token",
+     "error": "Method not allowed",
    },
  ]


Number of calls: 1

   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should handle metadata with all optional fields populated 2ms
     → expected "spy" to be called with arguments: [ { …(25) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "acr_values_supported": Array [
-       "1",
-       "2",
-     ],
-     "authorization_endpoint": "https://test.example.com/oauth2/authorize",
-     "claims_supported": Array [
-       "sub",
-       "iss",
-       "aud",
-       "exp",
-       "iat",
-       "name",
-       "preferred_username",
-       "email",
-       "email_verified",
-       "agent_id",
-       "agent_type",
-     ],
-     "code_challenge_methods_supported": Array [
-       "S256",
-       "plain",
-     ],
-     "grant_types_supported": Array [
-       "authorization_code",
-       "refresh_token",
-     ],
-     "id_token_signing_alg_values_supported": Array [
-       "RS256",
-       "HS256",
-     ],
-     "introspection_endpoint": "https://test.example.com/oauth2/introspect",
-     "introspection_endpoint_auth_methods_supported": Array [
-       "client_secret_basic",
-     ],
-     "issuer": "https://test.example.com",
-     "jwks_uri": "https://test.example.com/.well-known/jwks.json",
-     "op_policy_uri": "https://test.example.com/policy",
-     "op_tos_uri": "https://test.example.com/tos",
-     "registration_endpoint": "https://test.example.com/oauth2/register",
-     "response_modes_supported": Array [
-       "query",
-       "fragment",
-     ],
-     "response_types_supported": Array [
-       "code",
-       "code id_token",
-     ],
-     "revocation_endpoint": "https://test.example.com/oauth2/revoke",
-     "revocation_endpoint_auth_methods_supported": Array [
-       "client_secret_basic",
-     ],
-     "scopes_supported": Array [
-       "openid",
-       "profile",
-       "email",
-       "offline_access",
-       "agent",
-     ],
-     "service_documentation": "https://test.example.com/docs/api",
-     "subject_types_supported": Array [
-       "public",
-     ],
-     "token_endpoint": "https://test.example.com/oauth2/token",
-     "token_endpoint_auth_methods_supported": Array [
-       "client_secret_basic",
-       "client_secret_post",
-       "none",
-     ],
-     "token_endpoint_auth_signing_alg_values_supported": Array [
-       "RS256",
-       "HS256",
-     ],
-     "ui_locales_supported": Array [
-       "en",
-       "es",
-       "fr",
-     ],
-     "userinfo_endpoint": "https://test.example.com/oauth2/userinfo",
+     "error": "Method not allowed",
    },
  ]


Number of calls: 1

   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should propagate errors from auth module not being loaded 2ms
     → expected [Function] to throw an error
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should propagate errors from oauth2ConfigService being undefined 1ms
     → expected [Function] to throw an error
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should propagate errors from oauth2ConfigService method failure 1ms
     → expected [Function] to throw an error
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should handle response.json method throwing an error 1ms
     → expected "spy" to be called 1 times, but got 0 times
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should validate interface compliance with IOAuth2ServerMetadataInternal 1ms
     → expected { error: 'Method not allowed' } to have property "issuer"
   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should handle empty arrays in metadata 1ms
     → expected "spy" to be called with arguments: [ { …(8) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "authorization_endpoint": "https://empty.example.com/oauth2/authorize",
-     "claims_supported": Array [],
-     "grant_types_supported": Array [],
-     "issuer": "https://empty.example.com",
-     "jwks_uri": "https://empty.example.com/.well-known/jwks.json",
-     "response_types_supported": Array [],
-     "scopes_supported": Array [],
-     "token_endpoint": "https://empty.example.com/oauth2/token",
+     "error": "Method not allowed",
    },
  ]


Number of calls: 1

   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should preserve exact metadata structure without modification 1ms
     → expected "spy" to be called with arguments: [ { …(16) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "authorization_endpoint": "https://test.example.com/oauth2/authorize",
-     "claims_supported": Array [
-       "sub",
-       "iss",
-       "aud",
-       "exp",
-       "iat",
-       "name",
-       "preferred_username",
-       "email",
-       "email_verified",
-       "agent_id",
-       "agent_type",
-     ],
-     "code_challenge_methods_supported": Array [
-       "S256",
-       "plain",
-     ],
-     "grant_types_supported": Array [
-       "authorization_code",
-       "refresh_token",
-     ],
-     "id_token_signing_alg_values_supported": Array [
-       "RS256",
-       "HS256",
-     ],
-     "issuer": "https://test.example.com",
-     "jwks_uri": "https://test.example.com/.well-known/jwks.json",
-     "registration_endpoint": "https://test.example.com/oauth2/register",
-     "response_modes_supported": Array [
-       "query",
-       "fragment",
-     ],
-     "response_types_supported": Array [
-       "code",
-       "code id_token",
-     ],
-     "scopes_supported": Array [
-       "openid",
-       "profile",
-       "email",
-       "offline_access",
-       "agent",
-     ],
-     "service_documentation": "https://test.example.com/docs/api",
-     "subject_types_supported": Array [
-       "public",
-     ],
-     "token_endpoint": "https://test.example.com/oauth2/token",
-     "token_endpoint_auth_methods_supported": Array [
-       "client_secret_basic",
-       "client_secret_post",
-       "none",
-     ],
-     "userinfo_endpoint": "https://test.example.com/oauth2/userinfo",
+     "error": "Method not allowed",
    },
  ]


Number of calls: 1

   × AuthorizationServerEndpoint > getAuthorizationServerMetadata > should work with different request types 2ms
     → expected "spy" to be called with arguments: [ { …(16) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "authorization_endpoint": "https://test.example.com/oauth2/authorize",
-     "claims_supported": Array [
-       "sub",
-       "iss",
-       "aud",
-       "exp",
-       "iat",
-       "name",
-       "preferred_username",
-       "email",
-       "email_verified",
-       "agent_id",
-       "agent_type",
-     ],
-     "code_challenge_methods_supported": Array [
-       "S256",
-       "plain",
-     ],
-     "grant_types_supported": Array [
-       "authorization_code",
-       "refresh_token",
-     ],
-     "id_token_signing_alg_values_supported": Array [
-       "RS256",
-       "HS256",
-     ],
-     "issuer": "https://test.example.com",
-     "jwks_uri": "https://test.example.com/.well-known/jwks.json",
-     "registration_endpoint": "https://test.example.com/oauth2/register",
-     "response_modes_supported": Array [
-       "query",
-       "fragment",
-     ],
-     "response_types_supported": Array [
-       "code",
-       "code id_token",
-     ],
-     "scopes_supported": Array [
-       "openid",
-       "profile",
-       "email",
-       "offline_access",
-       "agent",
-     ],
-     "service_documentation": "https://test.example.com/docs/api",
-     "subject_types_supported": Array [
-       "public",
-     ],
-     "token_endpoint": "https://test.example.com/oauth2/token",
-     "token_endpoint_auth_methods_supported": Array [
-       "client_secret_basic",
-       "client_secret_post",
-       "none",
-     ],
-     "userinfo_endpoint": "https://test.example.com/oauth2/userinfo",
+     "error": "Method not allowed",
    },
  ]


Number of calls: 1

   × AuthorizationServerEndpoint > error boundary coverage > should handle auth module exports being null 1ms
     → expected [Function] to throw an error
   × AuthorizationServerEndpoint > error boundary coverage > should handle auth module exports being undefined 1ms
     → expected [Function] to throw an error
   × AuthorizationServerEndpoint > error boundary coverage > should handle oauth2ConfigService method being undefined 1ms
     → expected [Function] to throw an error
 ❯ tests/e2e/mcp-tool-permissions.spec.ts (13 tests | 13 failed) 436ms
   × MCP Tool Permissions E2E > Tool Listing > should return check-status tool for admin session 28ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Listing > should return empty tool list for basic session 5ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Listing > should return empty tool list without session 3ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Execution > should allow admin to execute check-status tool 2ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Execution > should deny basic user from executing check-status tool 3ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Execution > should return error for unknown tool 2ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Execution > should require session for tool execution 2ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Arguments > should accept valid arguments for check-status 2ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Tool Arguments > should handle invalid argument types 3ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Security Headers > should not expose internal metadata in tool list 2ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Rate Limiting > should handle multiple rapid requests 21ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Error Handling > should handle malformed JSON-RPC requests 3ms
     → expected 302 to be 200 // Object.is equality
   × MCP Tool Permissions E2E > Error Handling > should handle invalid method names 2ms
     → expected 302 to be 200 // Object.is equality
 ✓ tests/e2e/tunnel/cloudflared-tunnel.spec.ts (4 tests) 6584ms
   ✓ Cloudflared Tunnel E2E Tests > should start cloudflared tunnel in Docker and expose local service 5390ms

 Test Files  16 failed | 1 passed (17)
      Tests  169 failed | 74 passed (243)
   Start at  14:20:34
   Duration  7.56s (transform 5.31s, setup 196ms, collect 6.67s, tests 7.74s, environment 4ms, prepare 1.58s)

