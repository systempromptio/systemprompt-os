
 RUN  v2.1.9 /var/www/html/systemprompt-os
      Coverage enabled with v8

 ✓ tests/unit/modules/core/auth/providers/core/oauth2.spec.ts (13 tests) 13ms
 ✓ tests/unit/server/external/middleware/auth.spec.ts (9 tests) 13ms
 ✓ tests/unit/modules/core/auth/providers/core/github.spec.ts (11 tests) 15ms
 ✓ tests/unit/modules/core/auth/providers/core/google.spec.ts (14 tests) 15ms
 ✓ tests/unit/modules/core/config/cli/provider.spec.ts (20 tests) 20ms
 ✓ tests/unit/server/mcp/core/handlers/notifications.spec.ts (18 tests) 22ms
 ✓ tests/unit/modules/core/logger/logger.spec.ts (12 tests) 21ms
 ✓ tests/unit/server/mcp/core/handlers/prompt-handlers.spec.ts (9 tests) 39ms
 ✓ tests/unit/utils/json-schema-to-zod.spec.ts (18 tests) 16ms
 ✓ tests/unit/modules/core/extension/cli/list.spec.ts (9 tests) 14ms
 ✓ tests/unit/modules/core/auth/cli/tunnel.spec.ts (7 tests) 11ms
 ✓ tests/unit/modules/core/database/adapters/sqlite.adapter.spec.ts (22 tests) 24ms
 ✓ tests/unit/modules/core/config/cli/model.spec.ts (17 tests) 27ms
 ✓ tests/unit/modules/core/extension/cli/info.spec.ts (9 tests) 23ms
 ✓ tests/unit/modules/core/extension/cli/validate.spec.ts (8 tests) 10ms
 ✓ tests/unit/modules/core/auth/services/tunnel-service.spec.ts (9 tests) 33ms
 ✓ tests/unit/server/external/rest/oauth2/errors.spec.ts (18 tests) 8ms
 ✓ tests/unit/modules/core/database/index.spec.ts (10 tests) 15ms
 ✓ tests/unit/utils/logger.spec.ts (14 tests) 171ms
 ✓ tests/unit/modules/core/config/cli/validate.spec.ts (11 tests) 46ms
 ✓ tests/unit/server/external/rest/oauth2/well-known.spec.ts (8 tests) 25ms
 ✓ tests/unit/server/external/rest/oauth2/token.spec.ts (10 tests) 18ms
 ✓ tests/unit/modules/core/auth/utils/generate-key.spec.ts (7 tests) 27ms
 ✓ tests/unit/server/mcp/registry.spec.ts (21 tests) 114ms
 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts (14 tests | 5 failed) 56ms
   × OAuth2 Authorize Endpoint > postAuthorize > should generate authorization code with PKCE 11ms
     → Cannot read properties of undefined (reading '0')
   × OAuth2 Authorize Endpoint > postAuthorize > should redirect without state if not provided 4ms
     → expected "spy" to be called with arguments: [ StringMatching{…} ]

Received: 



Number of calls: 0

   × OAuth2 Authorize Endpoint > postAuthorize > should store authorization code with expiration 3ms
     → Cannot read properties of undefined (reading '0')
   × OAuth2 Authorize Endpoint > postAuthorize > should clean up expired authorization codes 2ms
     → expected "spy" to be called at least once
   × OAuth2 Authorize Endpoint > static methods > should delete authorization code 2ms
     → Cannot read properties of undefined (reading '0')
 ✓ tests/unit/server/mcp/core/handlers/tool-handlers.spec.ts (15 tests) 43ms
 ✓ tests/unit/server/mcp/core/handlers/tools/utils/validation.spec.ts (19 tests) 30ms
 ✓ tests/unit/cli/src/discovery.spec.ts (14 tests) 273ms
 ✓ tests/unit/server/middleware.spec.ts (15 tests) 368ms
 ✓ tests/unit/server/mcp/auth-adapter.spec.ts (8 tests) 12ms
 ✓ tests/unit/server/external/rest/oauth2/userinfo.spec.ts (9 tests) 15ms
 ✓ tests/unit/modules/core/extension/cli/install.spec.ts (6 tests) 12ms
 ✓ tests/unit/modules/core/auth/cli/providers.spec.ts (6 tests) 12ms
 ✓ tests/unit/modules/core/auth/cli/generatekey.spec.ts (7 tests) 14ms
 ✓ tests/unit/modules/core/extension/cli/remove.spec.ts (6 tests) 12ms
 ✓ tests/unit/modules/core/heartbeat/cli/status.spec.ts (9 tests) 24ms
 ✓ tests/unit/modules/core/cli/cli.spec.ts (9 tests) 14ms
 ✓ tests/unit/modules/core/config/providers/google.spec.ts (12 tests) 13ms
 ✓ tests/unit/modules/core/cli/cli/list.spec.ts (7 tests) 14ms
 ✓ tests/unit/utils/helpers.spec.ts (13 tests) 9ms
 ✓ tests/unit/server/mcp/index.spec.ts (10 tests) 17ms
 ✓ tests/unit/modules/core/config/cli/list.spec.ts (8 tests) 12ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/react-components.spec.ts (7 tests) 9ms
 ✓ tests/unit/modules/core/heartbeat/heartbeat.spec.ts (8 tests) 34ms
 ✓ tests/unit/modules/core/extension/extension.spec.ts (9 tests) 16ms
 ✓ tests/unit/modules/core/config/config.spec.ts (10 tests) 15ms
 ✓ tests/unit/server/external/auth/jwt.spec.ts (7 tests) 14ms
 ✓ tests/unit/modules/core/cli/cli/docs.spec.ts (6 tests) 24ms
 ✓ tests/unit/modules/registry.spec.ts (10 tests) 13ms
 ✓ tests/unit/server/mcp/loader.spec.ts (7 tests) 13ms
 ✓ tests/unit/modules/core/heartbeat/cli/reset.spec.ts (6 tests) 18ms
 ✓ tests/unit/modules/core/config/cli/set.spec.ts (11 tests) 18ms
 ✓ tests/unit/server/external/rest/health.spec.ts (5 tests) 21ms
 ✓ tests/unit/server/config.spec.ts (11 tests) 296ms
 ✓ tests/unit/cli/src/index.spec.ts (7 tests) 501ms
 ✓ tests/unit/modules/core/cli/cli/help.spec.ts (5 tests) 13ms
 ❯ tests/unit/modules/loader.spec.ts (11 tests | 2 failed) 145ms
   × ModuleLoader > loadModules > should handle missing config file gracefully 57ms
     → promise rejected "Error: [vitest] No "getLogger" export is … { codeFrame: '…' }" instead of resolving
   × ModuleLoader > loadModules > should load core modules when no config exists 72ms
     → promise rejected "Error: [vitest] No "getLogger" export is … { codeFrame: '…' }" instead of resolving
 ✓ tests/unit/modules/core/auth/tunnel-status.spec.ts (10 tests) 7ms
 ✓ tests/unit/server/mcp.spec.ts (3 tests) 28ms
 ✓ tests/unit/server/mcp/core/handlers/resources/task-output.spec.ts (8 tests) 13ms
 ✓ tests/unit/utils/id-validation.spec.ts (41 tests) 12ms
 ✓ tests/unit/server/mcp/core/utils/task-helpers.spec.ts (9 tests) 8ms
 ✓ tests/unit/server/mcp/core/handlers/resource-handlers.spec.ts (9 tests) 6ms
 ✓ tests/unit/server/mcp/core/permissions.spec.ts (7 tests) 7ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/unit-testing.spec.ts (7 tests) 8ms
 ✓ tests/unit/modules/core/config/cli/get.spec.ts (8 tests) 10ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/bug-fixing.spec.ts (6 tests) 6ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/index.spec.ts (10 tests) 8ms
 ✓ tests/unit/server/external/index.spec.ts (5 tests) 29ms
 ✓ tests/unit/server/mcp/core/constants/prompts.spec.ts (8 tests) 8ms
 ✓ tests/unit/server/external/rest/api/utils.spec.ts (6 tests) 6ms
 ✓ tests/unit/server/mcp-handler.spec.ts (18 tests) 40ms
 ✓ tests/unit/server/external/rest/splash.spec.ts (5 tests) 10ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/reddit-post.spec.ts (7 tests) 8ms
 ✓ tests/unit/modules/core/auth/services/tunnel-service.simple.spec.ts (6 tests) 8ms
 ✓ tests/unit/server/external/auth/providers/github.spec.ts (7 tests) 15ms
 ✓ tests/unit/server/mcp/core/constants/resources.spec.ts (9 tests) 11ms
 ✓ tests/unit/server/mcp/core/constants/task-status.spec.ts (10 tests) 11ms
 ✓ tests/unit/server/external/auth/providers/generic-oauth2.spec.ts (10 tests) 29ms
 ✓ tests/unit/server/mcp/config.spec.ts (7 tests) 11ms
 ✓ tests/unit/server/mcp/core/server.spec.ts (7 tests) 14ms
 ✓ tests/unit/index.spec.ts (4 tests) 141ms
 ✓ tests/unit/server/types.spec.ts (4 tests) 5ms
 ✓ tests/unit/server/mcp/core/constants/tool/check-status.spec.ts (6 tests) 5ms
 ✓ tests/unit/server/external/rest/api/config.spec.ts (5 tests) 5ms
 ✓ tests/unit/server/mcp/types.spec.ts (4 tests) 6ms
 ✓ tests/unit/server/mcp/core/types/session-states.spec.ts (5 tests) 6ms
 ✓ tests/unit/modules/core/config/types/config.spec.ts (3 tests) 5ms
 ✓ tests/unit/server/mcp/core/constants/tools.spec.ts (2 tests) 4ms
 ✓ tests/unit/server/external/auth/providers/google.spec.ts (6 tests) 13ms
 ✓ tests/unit/modules/core/auth/singleton.spec.ts (3 tests) 6ms
 ✓ tests/unit/server/index.spec.ts (12 tests) 1642ms
   ✓ Server > createApp > should create and configure Express app 873ms
 ✓ tests/unit/tools/generate-key/generate-key.spec.ts (6 tests) 1772ms
   ✓ CLI Key Generation > JWK format generation > should support RS512 algorithm 1242ms

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 7 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/modules/loader.spec.ts > ModuleLoader > loadModules > should handle missing config file gracefully
AssertionError: promise rejected "Error: [vitest] No "getLogger" export is … { codeFrame: '…' }" instead of resolving
 ❯ tests/unit/modules/loader.spec.ts:129:40
    127|       
    128|       const loader = new ModuleLoader();
    129|       await expect(loader.loadModules()).resolves.not.toThrow();
       |                                        ^
    130|       
    131|       expect(consoleWarnSpy).toHaveBeenCalledWith(

Caused by: Error: [vitest] No "getLogger" export is defined on the "../../../src/utils/logger" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

vi.mock(import("../../../src/utils/logger"), async (importOriginal) => {
  const actual = await importOriginal()
  return {
    ...actual,
    // your mocked methods
  }
})

 ❯ ModuleLoader.loadModules src/modules/loader.ts:120:13
 ❯ tests/unit/modules/loader.spec.ts:129:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/7]⎯

 FAIL  tests/unit/modules/loader.spec.ts > ModuleLoader > loadModules > should load core modules when no config exists
AssertionError: promise rejected "Error: [vitest] No "getLogger" export is … { codeFrame: '…' }" instead of resolving
 ❯ tests/unit/modules/loader.spec.ts:146:40
    144|       const loader = new ModuleLoader();
    145|       
    146|       await expect(loader.loadModules()).resolves.not.toThrow();
       |                                        ^
    147|       
    148|       expect(consoleWarnSpy).toHaveBeenCalledWith(

Caused by: Error: [vitest] No "getLogger" export is defined on the "../../../src/utils/logger" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

vi.mock(import("../../../src/utils/logger"), async (importOriginal) => {
  const actual = await importOriginal()
  return {
    ...actual,
    // your mocked methods
  }
})

 ❯ ModuleLoader.loadModules src/modules/loader.ts:120:13
 ❯ tests/unit/modules/loader.spec.ts:146:7

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/7]⎯

 FAIL  tests/unit/server/external/rest/oauth2/authorize.spec.ts > OAuth2 Authorize Endpoint > postAuthorize > should generate authorization code with PKCE
TypeError: Cannot read properties of undefined (reading '0')
 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts:272:68
    271|       expect(storedCode?.codeChallenge).toBe('challenge123');
    272|       expect(storedCode?.codeChallengeMethod).toBe('S256');
    273|     });
       |        ^
    274| 
    275|     it('should redirect without state if not provided', async () => {

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/7]⎯

 FAIL  tests/unit/server/external/rest/oauth2/authorize.spec.ts > OAuth2 Authorize Endpoint > postAuthorize > should redirect without state if not provided
AssertionError: expected "spy" to be called with arguments: [ StringMatching{…} ]

Received: 



Number of calls: 0

 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts:296:32
    296|       };
    297| 
    298|       await authorizeEndpoint.postAuthorize(mockReq as Request, mockRe…
       |                      ^
    299| 
    300|       expect(mockRes.status).toHaveBeenCalledWith(400);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/7]⎯

 FAIL  tests/unit/server/external/rest/oauth2/authorize.spec.ts > OAuth2 Authorize Endpoint > postAuthorize > should store authorization code with expiration
TypeError: Cannot read properties of undefined (reading '0')
 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts:331:68
    330|     it('should clean up expired authorization codes', async () => {
    331|       // Create an expired code manually
    332|       const expiredCode = 'expired-code';
       |                           ^
    333|       const expiredData = {
    334|         clientId: 'old-client',

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/7]⎯

 FAIL  tests/unit/server/external/rest/oauth2/authorize.spec.ts > OAuth2 Authorize Endpoint > postAuthorize > should clean up expired authorization codes
AssertionError: expected "spy" to be called at least once
 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts:364:32
    362|         action: 'approve',
    363|         response_type: 'code',
    364|         client_id: 'test-client',
       |                                ^
    365|         redirect_uri: 'http://localhost:3000/callback',
    366|         scope: 'read'

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[6/7]⎯

 FAIL  tests/unit/server/external/rest/oauth2/authorize.spec.ts > OAuth2 Authorize Endpoint > static methods > should delete authorization code
TypeError: Cannot read properties of undefined (reading '0')
 ❯ tests/unit/server/external/rest/oauth2/authorize.spec.ts:381:68
    380| 
    381|       // Verify code is deleted
    382|       expect(AuthorizeEndpoint.getAuthorizationCode(code!)).toBeUndefi…
       |                                    ^
    383|     });
    384|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[7/7]⎯

 Test Files  2 failed | 91 passed (93)
      Tests  7 failed | 887 passed (894)
   Start at  19:36:49
   Duration  3.60s (transform 10.83s, setup 1.48s, collect 20.04s, tests 6.77s, environment 33ms, prepare 11.74s)

