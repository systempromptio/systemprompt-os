services:
  systemprompt-os:
    image: systemprompt-os:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: systemprompt-os-test
    ports:
      - "3001:3000"
    environment:
      # Core settings
      - NODE_ENV=test
      - PORT=3000
      - DATABASE_FILE=/data/state/systemprompt.db
      - STATE_PATH=/data/state
      - PROJECTS_PATH=/data/projects
      - CONFIG_PATH=/data/config
      - LOG_LEVEL=debug
      
      # URLs and domains - use environment variable if cloudflare tunnel is enabled
      - BASE_URL=${BASE_URL:-http://localhost:3001}
      - OAUTH_DOMAIN=${OAUTH_DOMAIN:-http://localhost:3001}
      - TUNNEL_URL=${TUNNEL_URL:-}
      
      # File system settings
      - FILE_ROOT=/workspace
      - PROJECT_ROOT=/workspace
      - GIT_AVAILABLE=true
      
      # JWT Configuration (keys auto-generated on first run)
      - JWT_KEY_PATH=/data/state/auth/keys
      
      # OAuth Providers - use real credentials if available
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-test-google-client}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-test-google-secret}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-test-github-client}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-test-github-secret}
      
      # Tunnel configuration
      - ENABLE_OAUTH_TUNNEL=${ENABLE_OAUTH_TUNNEL:-true}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN:-}
      
      # MCP Settings
      - MCP_AUTH_REQUIRED=true
    volumes:
      # Persistent data storage
      - systemprompt-test-data:/data
      # Application logs
      - systemprompt-test-logs:/app/logs
      # Mount workspace for file operations
      - ./:/workspace:rw
    restart: "no"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

volumes:
  systemprompt-test-data:
    driver: local
  systemprompt-test-logs:
    driver: local