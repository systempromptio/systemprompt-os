services:
  systemprompt-os:
    image: systemprompt-os:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: systemprompt-os
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Core settings
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_FILE=/data/state/systemprompt.db
      - STATE_PATH=/data/state
      - PROJECTS_PATH=/data/projects
      - CONFIG_PATH=/data/config
      - LOG_LEVEL=${LOG_LEVEL:-info}
      
      # URLs and domains
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      - OAUTH_DOMAIN=${OAUTH_DOMAIN:-https://democontainer.systemprompt.io}
      
      # File system settings
      - FILE_ROOT=/workspace
      - PROJECT_ROOT=/workspace
      - GIT_AVAILABLE=${GIT_AVAILABLE:-true}
      
      # JWT Configuration (keys auto-generated on first run)
      - JWT_KEY_PATH=/data/state/auth/keys
      
      # OAuth Providers (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      
      # Cloudflare Tunnel (optional)
      - ENABLE_OAUTH_TUNNEL=${ENABLE_OAUTH_TUNNEL:-false}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
      
      # MCP Settings
      - MCP_AUTH_REQUIRED=${MCP_AUTH_REQUIRED:-true}
    volumes:
      # Persistent data storage
      - systemprompt-data:/data
      # Application logs
      - systemprompt-logs:/app/logs
      # Mount workspace for file operations (optional)
      - ${WORKSPACE_PATH:-./workspace}:/workspace:rw
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  systemprompt-data:
    driver: local
  systemprompt-logs:
    driver: local