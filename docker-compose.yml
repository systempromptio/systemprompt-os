version: '3.8'

services:
  systemprompt-os:
    image: systemprompt-os:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: systemprompt-os
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      - NODE_ENV=production
      - PORT=${PORT:-3000}
      - DATABASE_FILE=/data/state/systemprompt.db
      - OAUTH_DOMAIN=${OAUTH_DOMAIN:-https://democontainer.systemprompt.io}
      - STATE_PATH=/data/state
      - PROJECTS_PATH=/data/projects
      - FILE_ROOT=/workspace
      - PROJECT_ROOT=/workspace
      - GIT_AVAILABLE=${GIT_AVAILABLE:-true}
      # JWT Configuration (RSA keys auto-generated on first run)
      - JWT_KEY_PATH=/data/state/auth/keys
      # OAuth Providers
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      # Cloudflare Tunnel (optional)
      - ENABLE_OAUTH_TUNNEL=${ENABLE_OAUTH_TUNNEL:-false}
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      # Persistent data storage
      - systemprompt-data:/data
      # Application logs
      - systemprompt-logs:/app/logs
      # Mount workspace for file operations (optional)
      - ${WORKSPACE_PATH:-./workspace}:/workspace:rw
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s


volumes:
  systemprompt-data:
    driver: local
  systemprompt-logs:
    driver: local
