# Type Generation Plan

## Architecture Overview

1. **Database Layer** ‚Üí autogenerates types from schema.sql
2. **Service Layer** ‚Üí MUST use database types/subsets OR define own types in `service.types.manual.ts`
3. **Service Schemas** ‚Üí use TypeScript API to extract validated Zod schemas
4. **Module Types** ‚Üí autogenerated with valid module interface and service definitions

## Type Generation Flow

```
schema.sql
    ‚Üì
database.generated.ts (IUsersRow, enums, etc.)
    ‚Üì
module.generated.ts (UserSchema, UserCreateDataSchema, UserUpdateDataSchema)
    ‚Üì
service.generated.ts (Zod schemas for service methods)
    ‚Üì
Module validation (ensure all rules followed)
```

## Implementation Plan

### ‚úÖ Completed
- Database type generation from schema.sql
- Domain Zod schema generation (UserSchema, etc.)
- Basic service schema generation
- ServiceParserService for AST parsing
- Module validation CLI command

### üîÑ In Progress
- ‚òê Fix ServiceSchemaGenerator to correctly map database types
  - Map IUserCreateData ‚Üí UserCreateDataSchema
  - Map IUserUpdateData ‚Üí UserUpdateDataSchema
  - Map IUser ‚Üí UserSchema
- ‚òê Remove excessive nullable chains

### üìã TODO
- ‚òê Create TypeGenerationOrchestrator service to run stages with validation
- ‚òê Add support for service.types.manual.ts in type generation flow
- ‚òê Implement stage validation (database ‚Üí service ‚Üí module)
- ‚òê Create ModuleValidationService with strict rule enforcement
- ‚òê Add validation: services must use database types or manual types only
- ‚òê Change warnings to errors for non-conformant types
- ‚òê Test complete flow with users module

## Key Changes Needed

### 1. Service Type Resolution
```typescript
// Current (broken)
createUser(data: IUserCreateData) ‚Üí UserSchema ‚ùå

// Should be
createUser(data: IUserCreateData) ‚Üí UserCreateDataSchema ‚úÖ
```

### 2. Manual Types Support
```typescript
// services/auth/auth.types.manual.ts
export interface IAuthToken {
  token: string;
  expiresAt: Date;
}
```

### 3. Stage Validation
- **Stage 1**: Validate database.generated.ts exists
- **Stage 2**: Validate services use only database/manual types  
- **Stage 3**: Validate module exports match interface

### 4. Strict Rules Enforcement
- No inline type definitions
- No types outside database.generated.ts or *.types.manual.ts
- All service methods must have Zod schemas
- Throw errors (not warnings) for violations

## CLI Usage

**IMPORTANT: MUST use CLI commands only. NEVER use npm/npx commands.**

```bash
# Generate types for a module
/var/www/html/systemprompt-os/bin/systemprompt dev generate-types --module <module>

# Validate module conformance  
/var/www/html/systemprompt-os/bin/systemprompt dev validate-module --module <module>
```

## Success Criteria

Success is achieved when ALL of the following conditions are met:

1. **Type Generation Success**
   - `/var/www/html/systemprompt-os/bin/systemprompt dev generate-types --module users` runs without errors
   - All generated files are syntactically correct
   - No warnings about unknown types

2. **Module Validation Success**
   - `/var/www/html/systemprompt-os/bin/systemprompt dev validate-module --module users` passes all checks
   - No manual type files exist (only generated types)
   - All service methods have proper Zod schemas

3. **Integration Tests Pass**
   - Module can be loaded and initialized without errors
   - Service methods can be called with runtime validation
   - Zod schemas correctly validate input/output at runtime