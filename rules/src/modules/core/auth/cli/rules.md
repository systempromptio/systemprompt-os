# Auth Module CLI Rules

## Overview
The auth module CLI provides comprehensive command-line interfaces for authentication, session management, and OAuth provider configuration. All commands must follow strict architectural patterns and use ONLY the exported AuthService to maintain module boundaries.

## Architecture Requirements

### Service Layer Compliance
**CRITICAL**: ALL CLI commands MUST use ONLY the exported AuthService:
```typescript
import { AuthService } from '../services/auth.service';
const authService = AuthService.getInstance();
```

**FORBIDDEN PATTERNS**:
- ❌ Direct import of internal services: `SessionService`, `TokenService`, `ProvidersService`
- ❌ Direct database access through repositories
- ❌ Accessing internal module implementation details

### Command Implementation Standards

1. **Required Imports**
```typescript
import type { ICLICommand, ICLIContext } from '@/modules/core/cli/types/index';
import { CliOutputService } from '@/modules/core/cli/services/cli-output.service';
import { LoggerService } from '@/modules/core/logger/services/logger.service';
import { LogSource } from '@/modules/core/logger/types/index';
import { AuthService } from '../services/auth.service';
```

2. **Zod Validation with Autogenerated Schemas**
```typescript
import { 
  AuthCreateDataSchema,
  AuthUpdateDataSchema 
} from '../types/auth.module.generated';

// Extend schemas for CLI-specific needs
const sessionCreateSchema = z.object({
  userId: z.string().uuid('Invalid user ID format'),
  format: z.enum(['text', 'json']).default('text')
});
```

3. **Output Format Requirements**
- ALL data commands MUST support `--format json`
- Use `CliOutputService` exclusively - NO `console.log`
- JSON output must contain full database objects (no field filtering)
- Table output must use clean, professional formatting

4. **Error Handling**
- Proper exit codes: 0 for success, 1 for errors
- User-friendly validation error messages
- Structured error logging with LogSource.AUTH

## Command Categories

### 1. Session Management Commands

#### `auth session create`
- **Purpose**: Create new user session
- **Required Args**: `--user-id <uuid>`
- **Options**: `--format <text|json>`
- **Service Method**: `authService.createSession(userId)`
- **JSON Output**: Full session object with metadata

#### `auth session list`
- **Purpose**: List sessions for a user
- **Required Args**: `--user-id <uuid>`
- **Options**: `--format <text|json>`, `--limit <number>`, `--page <number>`
- **Service Method**: `authService.listSessions(userId)`
- **JSON Output**: Array of session objects

#### `auth session validate`
- **Purpose**: Validate session token
- **Required Args**: `--session-id <uuid>`
- **Options**: `--format <text|json>`
- **Service Method**: `authService.validateSession(sessionId)`
- **JSON Output**: Validation result with user info

#### `auth session revoke`
- **Purpose**: Revoke active session
- **Required Args**: `--session-id <uuid>`
- **Options**: `--format <text|json>`
- **Service Method**: `authService.revokeSession(sessionId)`
- **JSON Output**: Revocation confirmation

### 2. Authentication Commands

#### `auth authenticate`
- **Purpose**: Authenticate user credentials
- **Required Args**: `--email <email>`, `--password <password>`
- **Options**: `--format <text|json>`
- **Service Method**: `authService.authenticate(email, password)`
- **JSON Output**: Authentication result with session info

### 3. Status and Information Commands

#### `auth status`
- **Purpose**: Show auth module status and health
- **Options**: `--format <text|json>`
- **Service Methods**: Use AuthService methods only
- **JSON Output**: Complete module status object

### 4. Provider Management Commands

#### `auth providers list`
- **Purpose**: List configured OAuth providers
- **Options**: `--format <text|json>`
- **Service Method**: Via AuthService if available
- **JSON Output**: Array of provider configurations

## Implementation Patterns

### Command Structure Template
```typescript
export const command: ICLICommand = {
  description: 'Clear description of command purpose',
  options: [
    {
      name: 'format',
      alias: 'f',
      type: 'string',
      description: 'Output format',
      choices: ['text', 'json'],
      default: 'text'
    },
    // ... other options
  ],
  execute: async (context: ICLIContext): Promise<void> => {
    const cliOutput = CliOutputService.getInstance();
    const logger = LoggerService.getInstance();
    
    try {
      // 1. Validate arguments with Zod
      const validatedArgs = commandSchema.parse(context.args);
      
      // 2. Get AuthService instance
      const authService = AuthService.getInstance();
      
      // 3. Execute operation through service
      const result = await authService.methodName(validatedArgs);
      
      // 4. Output based on format
      if (validatedArgs.format === 'json') {
        cliOutput.json(result);
      } else {
        // Human-readable output
        cliOutput.section('Operation Result');
        cliOutput.keyValue({
          'Field': result.value,
          // ... other fields
        });
      }
      
      process.exit(0);
    } catch (error) {
      // Proper error handling
      if (error instanceof z.ZodError) {
        cliOutput.error('Invalid arguments:');
        error.errors.forEach(err => {
          cliOutput.error(`  ${err.path.join('.')}: ${err.message}`);
        });
      } else {
        cliOutput.error('Command failed');
        logger.error(LogSource.AUTH, 'CLI command error', { error });
      }
      process.exit(1);
    }
  }
};
```

### Validation Utilities
```typescript
// auth/utils/cli-validation.ts
import { z } from 'zod';

export const cliSchemas = {
  sessionCreate: z.object({
    userId: z.string().uuid('Invalid user ID format'),
    format: z.enum(['text', 'json']).default('text')
  }),
  
  sessionList: z.object({
    userId: z.string().uuid('Invalid user ID format'),
    format: z.enum(['text', 'json']).default('text'),
    limit: z.coerce.number().positive().max(100).default(20),
    page: z.coerce.number().positive().default(1)
  }),
  
  authenticate: z.object({
    email: z.string().email('Invalid email format'),
    password: z.string().min(1, 'Password is required'),
    format: z.enum(['text', 'json']).default('text')
  })
};
```

## Service Integration Requirements

### AuthService Methods Required
The CLI commands depend on these AuthService methods:

**Currently Available**:
- `authenticate(email: string, password: string)` - User authentication
- `createSession(userId: string)` - Session creation
- `validateSession(sessionId: string)` - Session validation
- `revokeSession(sessionId: string)` - Session revocation
- `listSessions(userId: string)` - List user sessions

**May Need to Add**:
- Provider management methods if needed for provider commands
- Token management methods if token commands are implemented

## Integration Test Requirements

All CLI commands MUST have integration tests in:
`/tests/integration/modules/core/auth/cli/{command}.integration.test.ts`

### Test Coverage Requirements
1. **Success Scenarios**: Valid arguments, proper JSON output
2. **Validation Errors**: Invalid arguments, missing required fields
3. **Service Errors**: Network failures, service unavailable
4. **Format Support**: Both text and JSON output modes
5. **Exit Codes**: Verify proper exit codes for success/failure

### Test Template
```typescript
import { runCLICommand } from '@/tests/utils/cli-runner';

describe('auth {command} CLI command', () => {
  describe('Execution', () => {
    it('should execute successfully with valid arguments', async () => {
      const { stdout, stderr, exitCode } = await runCLICommand(
        'auth', 
        '{command}', 
        ['--required-arg', 'value', '--format', 'json']
      );
      
      expect(exitCode).toBe(0);
      expect(stderr).toBe('');
      expect(() => JSON.parse(stdout)).not.toThrow();
    });
    
    it('should return proper JSON format', async () => {
      const { stdout } = await runCLICommand(
        'auth', 
        '{command}', 
        ['--valid-args', '--format', 'json']
      );
      
      const output = JSON.parse(stdout);
      // Validate output structure
    });
    
    it('should handle validation errors', async () => {
      const { stderr, exitCode } = await runCLICommand(
        'auth', 
        '{command}', 
        ['--invalid-arg', 'value']
      );
      
      expect(exitCode).toBe(1);
      expect(stderr).toContain('Invalid arguments');
    });
  });
});
```

## Module Boundary Enforcement

The auth CLI implementation MUST respect module boundaries:

1. **ONLY use exported AuthService** - No direct access to internal services
2. **Event-based communication** - For inter-module interactions
3. **No circular dependencies** - Clean module isolation
4. **Proper error boundaries** - Graceful handling of service failures

## Quality Standards

1. **Professional Output**: Clean, consistent formatting without decorative elements
2. **Machine Readable**: JSON output must be parseable and structured
3. **User Friendly**: Clear error messages and helpful validation feedback
4. **Performance**: Efficient service method calls, minimal overhead
5. **Security**: Proper input validation, no credential leakage in output

## Future Enhancements

1. **Interactive Mode**: Multi-step authentication flows
2. **Batch Operations**: Multiple session operations in one command
3. **Advanced Filtering**: Complex query options for listing commands
4. **Export/Import**: Configuration backup and restore commands