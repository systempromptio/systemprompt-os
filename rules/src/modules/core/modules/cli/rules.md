# Modules Module CLI Rules

## Overview
The modules module CLI provides comprehensive command-line interfaces for module lifecycle management, discovery, and status monitoring. All commands must follow strict architectural patterns and use ONLY the exported ModulesModuleService to maintain module boundaries.

## Architecture Requirements

### Service Layer Compliance
**CRITICAL**: ALL CLI commands MUST use ONLY the exported ModulesModuleService:
```typescript
import { ModulesModuleService } from '../services/modules.service';
const modulesService = ModulesModuleService.getInstance();
```

**FORBIDDEN PATTERNS**:
- ❌ Direct import of internal services: `ModuleManagerService`, `ModuleLoaderService`, `ModuleRegistryService`
- ❌ Direct database access through repositories
- ❌ Accessing internal module implementation details

### Command Implementation Standards

1. **Required Imports**
```typescript
import type { ICLICommand, ICLIContext } from '@/modules/core/cli/types/index';
import { CliOutputService } from '@/modules/core/cli/services/cli-output.service';
import { LoggerService } from '@/modules/core/logger/services/logger.service';
import { LogSource } from '@/modules/core/logger/types/index';
import { ModulesModuleService } from '../services/modules.service';
```

2. **Zod Validation with Autogenerated Schemas**
```typescript
import { 
  ModulesCreateDataSchema,
  ModulesUpdateDataSchema 
} from '../types/modules.module.generated';

// Extend schemas for CLI-specific needs
const moduleListSchema = z.object({
  type: z.enum(['all', 'core', 'extension']).default('all'),
  format: z.enum(['text', 'json', 'table']).default('text')
});
```

3. **Output Format Requirements**
- ALL data commands MUST support `--format json`
- Use `CliOutputService` exclusively - NO `console.log`
- JSON output must contain full database objects (no field filtering)
- Table output must use clean, professional formatting

4. **Error Handling**
- Proper exit codes: 0 for success, 1 for errors
- User-friendly validation error messages
- Structured error logging with LogSource.MODULES

## Command Categories

### 1. Module Information Commands

#### `modules status`
- **Purpose**: Show modules module status and health
- **Options**: `--format <text|json>`
- **Service Method**: `modulesService.healthCheck()`
- **JSON Output**: Complete module status with statistics

#### `modules list`
- **Purpose**: List all registered modules
- **Options**: `--type <all|core|extension>`, `--format <text|json|table>`
- **Service Method**: Via ModulesModuleService exported methods
- **JSON Output**: Array of module objects with full metadata

### 2. Module Management Commands

#### `modules setup`
- **Purpose**: Setup and maintain module database
- **Required Args**: `--action <install|clean|update|validate>`
- **Options**: `--force`, `--format <text|json>`
- **Service Method**: Via ModulesModuleService exported setup methods
- **JSON Output**: Setup operation results

## Implementation Patterns

### Command Structure Template
```typescript
export const command: ICLICommand = {
  description: 'Clear description of command purpose',
  options: [
    {
      name: 'format',
      alias: 'f',
      type: 'string',
      description: 'Output format',
      choices: ['text', 'json'],
      default: 'text'
    },
    // ... other options
  ],
  execute: async (context: ICLIContext): Promise<void> => {
    const cliOutput = CliOutputService.getInstance();
    const logger = LoggerService.getInstance();
    
    try {
      // 1. Validate arguments with Zod
      const validatedArgs = commandSchema.parse(context.args);
      
      // 2. Get ModulesModuleService instance
      const modulesService = ModulesModuleService.getInstance();
      
      // 3. Execute operation through service
      const result = await modulesService.methodName(validatedArgs);
      
      // 4. Output based on format
      if (validatedArgs.format === 'json') {
        cliOutput.json(result);
      } else {
        // Human-readable output
        cliOutput.section('Operation Result');
        cliOutput.keyValue({
          'Field': result.value,
          // ... other fields
        });
      }
      
      process.exit(0);
    } catch (error) {
      // Proper error handling
      if (error instanceof z.ZodError) {
        cliOutput.error('Invalid arguments:');
        error.errors.forEach(err => {
          cliOutput.error(`  ${err.path.join('.')}: ${err.message}`);
        });
      } else {
        cliOutput.error('Command failed');
        logger.error(LogSource.MODULES, 'CLI command error', { error });
      }
      process.exit(1);
    }
  }
};
```

### Validation Utilities
```typescript
// modules/utils/cli-validation.ts
import { z } from 'zod';

export const cliSchemas = {
  moduleList: z.object({
    type: z.enum(['all', 'core', 'extension']).default('all'),
    format: z.enum(['text', 'json', 'table']).default('text')
  }),
  
  moduleSetup: z.object({
    action: z.enum(['install', 'clean', 'update', 'validate']),
    force: z.boolean().default(false),
    format: z.enum(['text', 'json']).default('text')
  }),
  
  moduleStatus: z.object({
    format: z.enum(['text', 'json']).default('text')
  })
};
```

## Service Integration Requirements

### ModulesModuleService Methods Required
The CLI commands depend on these ModulesModuleService methods:

**Currently Available**:
- `healthCheck()` - Module health status
- `scanForModules()` - Module discovery
- `getEnabledModules()` - List enabled modules
- `getModule(name)` - Get specific module
- `enableModule(name)` - Enable module
- `disableModule(name)` - Disable module

**May Need to Add**:
- Setup and maintenance methods for setup command
- Statistics and reporting methods for status command

## Integration Test Requirements

All CLI commands MUST have integration tests in:
`/tests/integration/modules/core/modules/cli/{command}.integration.test.ts`

### Test Coverage Requirements
1. **Success Scenarios**: Valid arguments, proper JSON output
2. **Validation Errors**: Invalid arguments, missing required fields
3. **Service Errors**: Network failures, service unavailable
4. **Format Support**: Both text and JSON output modes
5. **Exit Codes**: Verify proper exit codes for success/failure

### Test Template
```typescript
import { runCLICommand } from '@/tests/utils/cli-runner';

describe('modules {command} CLI command', () => {
  describe('Execution', () => {
    it('should execute successfully with valid arguments', async () => {
      const { stdout, stderr, exitCode } = await runCLICommand(
        'modules', 
        '{command}', 
        ['--required-arg', 'value', '--format', 'json']
      );
      
      expect(exitCode).toBe(0);
      expect(stderr).toBe('');
      expect(() => JSON.parse(stdout)).not.toThrow();
    });
    
    it('should return proper JSON format', async () => {
      const { stdout } = await runCLICommand(
        'modules', 
        '{command}', 
        ['--valid-args', '--format', 'json']
      );
      
      const output = JSON.parse(stdout);
      // Validate output structure
    });
    
    it('should handle validation errors', async () => {
      const { stderr, exitCode } = await runCLICommand(
        'modules', 
        '{command}', 
        ['--invalid-arg', 'value']
      );
      
      expect(exitCode).toBe(1);
      expect(stderr).toContain('Invalid arguments');
    });
  });
});
```

## Module Boundary Enforcement

The modules CLI implementation MUST respect module boundaries:

1. **ONLY use exported ModulesModuleService** - No direct access to internal services
2. **Event-based communication** - For inter-module interactions
3. **No circular dependencies** - Clean module isolation
4. **Proper error boundaries** - Graceful handling of service failures

## Quality Standards

1. **Professional Output**: Clean, consistent formatting without decorative elements
2. **Machine Readable**: JSON output must be parseable and structured
3. **User Friendly**: Clear error messages and helpful validation feedback
4. **Performance**: Efficient service method calls, minimal overhead
5. **Security**: Proper input validation, no sensitive data leakage in output

## Future Enhancements

1. **Interactive Mode**: Multi-step module management flows
2. **Batch Operations**: Multiple module operations in one command
3. **Advanced Filtering**: Complex query options for listing commands
4. **Export/Import**: Module configuration backup and restore commands