# Tasks Module CLI Rules

## Overview
The tasks module CLI provides comprehensive command-line interfaces for task queue management, job execution, and task monitoring. All commands must follow strict architectural patterns and use ONLY the exported TasksService to maintain module boundaries.

## Architecture Requirements

### Service Layer Compliance
**CRITICAL**: ALL CLI commands MUST use ONLY the exported TasksService:
```typescript
import { TasksService } from '../services/tasks.service';
const tasksService = TasksService.getInstance();
```

**FORBIDDEN PATTERNS**:
- ❌ Direct import of internal services or repositories
- ❌ Direct database access through repositories
- ❌ Accessing internal module implementation details

### Command Implementation Standards

1. **Required Imports**
```typescript
import type { ICLICommand, ICLIContext } from '@/modules/core/cli/types/index';
import { CliOutputService } from '@/modules/core/cli/services/cli-output.service';
import { LoggerService } from '@/modules/core/logger/services/logger.service';
import { LogSource } from '@/modules/core/logger/types/index';
import { TasksService } from '../services/tasks.service';
```

2. **Zod Validation with Autogenerated Schemas**
```typescript
import { 
  TaskCreateDataSchema,
  TaskUpdateDataSchema 
} from '../types/tasks.module.generated';

// Extend schemas for CLI-specific needs
const taskCreateSchema = TaskCreateDataSchema.extend({
  format: z.enum(['text', 'json']).default('text')
});
```

3. **Output Format Requirements**
- ALL data commands MUST support `--format json`
- Use `CliOutputService` exclusively - NO `console.log`
- JSON output must contain full database objects (no field filtering)
- Table output must use clean, professional formatting

4. **Error Handling**
- Proper exit codes: 0 for success, 1 for errors
- User-friendly validation error messages
- Structured error logging with LogSource.TASKS

## Command Categories

### 1. Task Management Commands

#### `tasks status`
- **Purpose**: Show task module status and queue statistics
- **Options**: `--format <text|json>`
- **Service Method**: `tasksService.getStatus()`
- **JSON Output**: Complete module status with queue statistics

#### `tasks create` (replaces `add`)
- **Purpose**: Create a new task in the queue
- **Required Args**: `--type <string>`, `--module-id <string>`
- **Options**: 
  - `--instructions <string>` - Task instructions (JSON format)
  - `--priority <number>` - Task priority (default: 0)
  - `--status <string>` - Initial status (default: pending)
  - `--max-executions <number>` - Maximum executions (default: 3)
  - `--format <text|json>`
- **Service Method**: `tasksService.createTask(taskData)`
- **JSON Output**: Created task object with full metadata

#### `tasks list`
- **Purpose**: List tasks in the queue
- **Options**: 
  - `--status <string>` - Filter by task status
  - `--limit <number>` - Number of tasks to show (default: 10)
  - `--page <number>` - Page number for pagination (default: 1)
  - `--format <text|json>`
- **Service Method**: `tasksService.listTasks(filters)`
- **JSON Output**: Array of task objects

#### `tasks get`
- **Purpose**: Get detailed information about a specific task
- **Required Args**: `--id <number>` - Task ID
- **Options**: `--format <text|json>`
- **Service Method**: `tasksService.getTaskById(id)`
- **JSON Output**: Single task object with full details

#### `tasks update`
- **Purpose**: Update an existing task
- **Required Args**: `--id <number>` - Task ID
- **Options**: 
  - `--status <string>` - Task status
  - `--instructions <string>` - Task instructions
  - `--priority <number>` - Task priority
  - `--max-executions <number>` - Maximum executions
  - `--progress <number>` - Task progress (0-100)
  - `--result <string>` - Task result
  - `--error <string>` - Task error message
  - `--format <text|json>`
- **Service Method**: `tasksService.updateTask(id, updateData)`
- **JSON Output**: Updated task object

#### `tasks cancel`
- **Purpose**: Cancel a pending task
- **Required Args**: `--id <number>` - Task ID
- **Options**: `--format <text|json>`
- **Service Method**: `tasksService.cancelTask(id)`
- **JSON Output**: Cancellation confirmation with task details

#### `tasks delete`
- **Purpose**: Delete tasks by type or criteria
- **Required Args**: `--type <string>` - Task type to delete (or 'all')
- **Options**: `--format <text|json>`
- **Service Method**: `tasksService.deleteTasks(criteria)`
- **JSON Output**: Deletion summary with affected task count

## Implementation Patterns

### Command Structure Template
```typescript
export const command: ICLICommand = {
  description: 'Clear description of command purpose',
  options: [
    {
      name: 'format',
      alias: 'f',
      type: 'string',
      description: 'Output format',
      choices: ['text', 'json'],
      default: 'text'
    },
    // ... other options
  ],
  execute: async (context: ICLIContext): Promise<void> => {
    const cliOutput = CliOutputService.getInstance();
    const logger = LoggerService.getInstance();
    
    try {
      // 1. Validate arguments with Zod
      const validatedArgs = commandSchema.parse(context.args);
      
      // 2. Get TasksService instance
      const tasksService = TasksService.getInstance();
      
      // 3. Execute operation through service
      const result = await tasksService.methodName(validatedArgs);
      
      // 4. Output based on format
      if (validatedArgs.format === 'json') {
        cliOutput.json(result);
      } else {
        // Human-readable output
        cliOutput.section('Task Operation Result');
        cliOutput.keyValue({
          'Task ID': result.id?.toString() || 'N/A',
          'Status': result.status || 'Unknown',
          // ... other fields
        });
      }
      
      process.exit(0);
    } catch (error) {
      // Proper error handling
      if (error instanceof z.ZodError) {
        cliOutput.error('Invalid arguments:');
        error.errors.forEach(err => {
          cliOutput.error(`  ${err.path.join('.')}: ${err.message}`);
        });
      } else {
        cliOutput.error('Command failed');
        logger.error(LogSource.TASKS, 'CLI command error', { error });
      }
      process.exit(1);
    }
  }
};
```

### Validation Utilities
```typescript
// tasks/utils/cli-validation.ts
import { z } from 'zod';
import { TaskCreateDataSchema, TaskUpdateDataSchema } from '../types/tasks.module.generated';

export const cliSchemas = {
  create: TaskCreateDataSchema.extend({
    format: z.enum(['text', 'json']).default('text')
  }),
  
  update: TaskUpdateDataSchema.partial().extend({
    id: z.coerce.number().positive('Task ID must be a positive number'),
    format: z.enum(['text', 'json']).default('text')
  }),
  
  list: z.object({
    status: z.string().optional(),
    limit: z.coerce.number().positive().max(100).default(10),
    page: z.coerce.number().positive().default(1),
    format: z.enum(['text', 'json']).default('text')
  }),
  
  get: z.object({
    id: z.coerce.number().positive('Task ID must be a positive number'),
    format: z.enum(['text', 'json']).default('text')
  }),
  
  cancel: z.object({
    id: z.coerce.number().positive('Task ID must be a positive number'),
    format: z.enum(['text', 'json']).default('text')
  }),
  
  delete: z.object({
    type: z.string().min(1, 'Task type is required'),
    format: z.enum(['text', 'json']).default('text')
  })
};
```

## Service Integration Requirements

### TasksService Methods Required
The CLI commands depend on these TasksService methods:

**Currently Available**:
- Basic task service methods should be available

**May Need to Add**:
- `getStatus()` - Module status and queue statistics
- `createTask(taskData)` - Create new task
- `listTasks(filters)` - List tasks with filtering
- `getTaskById(id)` - Get single task details
- `updateTask(id, updateData)` - Update existing task
- `cancelTask(id)` - Cancel pending task
- `deleteTasks(criteria)` - Delete tasks by criteria

## Integration Test Requirements

All CLI commands MUST have integration tests in:
`/tests/integration/modules/core/tasks/cli/{command}.integration.test.ts`

### Test Coverage Requirements
1. **Success Scenarios**: Valid arguments, proper JSON output
2. **Validation Errors**: Invalid arguments, missing required fields
3. **Service Errors**: Network failures, service unavailable
4. **Format Support**: Both text and JSON output modes
5. **Exit Codes**: Verify proper exit codes for success/failure

### Test Template
```typescript
import { runCLICommand } from '@/tests/utils/cli-runner';

describe('tasks {command} CLI command', () => {
  describe('Execution', () => {
    it('should execute successfully with valid arguments', async () => {
      const { stdout, stderr, exitCode } = await runCLICommand(
        'tasks', 
        '{command}', 
        ['--required-arg', 'value', '--format', 'json']
      );
      
      expect(exitCode).toBe(0);
      expect(stderr).toBe('');
      expect(() => JSON.parse(stdout)).not.toThrow();
    });
    
    it('should return proper JSON format', async () => {
      const { stdout } = await runCLICommand(
        'tasks', 
        '{command}', 
        ['--valid-args', '--format', 'json']
      );
      
      const output = JSON.parse(stdout);
      // Validate output structure
    });
    
    it('should handle validation errors', async () => {
      const { stderr, exitCode } = await runCLICommand(
        'tasks', 
        '{command}', 
        ['--invalid-arg', 'value']
      );
      
      expect(exitCode).toBe(1);
      expect(stderr).toContain('Invalid arguments');
    });
  });
});
```

## Module Boundary Enforcement

The tasks CLI implementation MUST respect module boundaries:

1. **ONLY use exported TasksService** - No direct access to internal services
2. **Event-based communication** - For inter-module interactions
3. **No circular dependencies** - Clean module isolation
4. **Proper error boundaries** - Graceful handling of service failures

## Quality Standards

1. **Professional Output**: Clean, consistent formatting without decorative elements
2. **Machine Readable**: JSON output must be parseable and structured
3. **User Friendly**: Clear error messages and helpful validation feedback
4. **Performance**: Efficient service method calls, minimal overhead
5. **Security**: Proper input validation, no sensitive data leakage in output

## Command Naming Consistency

- Use `create` instead of `add` for consistency with other modules
- Include `get` command for single task retrieval
- Follow standard CRUD operations: create, list, get, update, delete
- Add task-specific operations: cancel, status

## Future Enhancements

1. **Batch Operations**: Multiple task operations in one command
2. **Advanced Filtering**: Complex query options for listing commands
3. **Task Templates**: Predefined task configurations
4. **Monitoring**: Real-time task queue monitoring commands