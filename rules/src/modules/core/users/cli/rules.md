# Users Module CLI Rules

## Overview
The users module CLI provides comprehensive command-line interfaces for user management operations. All commands must follow strict architectural patterns and use ONLY the exported UsersService to maintain module boundaries.

## Architecture Requirements

### Service Layer Compliance
**CRITICAL**: ALL CLI commands MUST use ONLY the exported UsersService:
```typescript
import { UsersService } from '../services/users.service';
const usersService = UsersService.getInstance();
```

**FORBIDDEN PATTERNS**:
- ❌ Direct import of internal services or repositories
- ❌ Direct database access through repositories
- ❌ Accessing internal module implementation details

### Command Implementation Standards

1. **Required Imports**
```typescript
import type { ICLICommand, ICLIContext } from '@/modules/core/cli/types/index';
import { CliOutputService } from '@/modules/core/cli/services/cli-output.service';
import { LoggerService } from '@/modules/core/logger/services/logger.service';
import { LogSource } from '@/modules/core/logger/types/index';
import { UsersService } from '../services/users.service';
```

2. **Zod Validation with Autogenerated Schemas**
```typescript
import { 
  UserCreateDataSchema,
  UserUpdateDataSchema 
} from '../types/users.module.generated';
import { UsersStatusSchema } from '../types/database.generated';

// Extend schemas for CLI-specific needs
const createUserArgsSchema = UserCreateDataSchema.extend({
  format: z.enum(['text', 'json']).default('text'),
  emailVerified: z.enum(['true', 'false'])
    .transform(v => v === 'true')
    .optional()
    .default('false')
}).transform(data => ({
  ...data,
  email_verified: data.emailVerified
}));
```

3. **Output Format Requirements**
- ALL data commands MUST support `--format json`
- Use `CliOutputService` exclusively - NO `console.log`
- JSON output must contain full database objects (no field filtering)
- Table output must use clean, professional formatting

4. **Error Handling**
- Proper exit codes: 0 for success, 1 for errors
- User-friendly validation error messages
- Structured error logging with LogSource.USERS

## Command Categories

### 1. User Management Commands

#### `users status`
- **Purpose**: Show users module status and health
- **Options**: `--format <text|json>`
- **Service Methods**: `usersService.listUsers()` for statistics
- **JSON Output**: Complete module status object with statistics

#### `users create`
- **Purpose**: Create new user
- **Required Args**: `--username <string>`, `--email <email>`
- **Options**: `--display_name <string>`, `--avatar_url <url>`, `--bio <string>`, `--timezone <string>`, `--language <string>`, `--status <active|inactive|suspended>`, `--emailVerified <true|false>`, `--format <text|json>`
- **Service Method**: `usersService.createUser(userData)`
- **JSON Output**: Full user object with all fields

#### `users list`
- **Purpose**: List users with filtering and pagination
- **Options**: `--status <active|inactive|suspended>`, `--limit <number>`, `--page <number>`, `--format <text|json>`
- **Service Method**: `usersService.listUsers()`
- **JSON Output**: Array of full user objects

#### `users get`
- **Purpose**: Get user information by ID or username
- **Required Args**: Either `--id <uuid>` or `--username <string>`
- **Options**: `--format <text|json>`
- **Service Methods**: `usersService.getUser(id)` or `usersService.getUserByUsername(username)`
- **JSON Output**: Full user object with all fields

#### `users update`
- **Purpose**: Update user information
- **Required Args**: `--id <uuid>`
- **Options**: `--username <string>`, `--email <email>`, `--display_name <string>`, `--avatar_url <url>`, `--bio <string>`, `--timezone <string>`, `--language <string>`, `--status <active|inactive|suspended>`, `--email_verified <true|false>`, `--format <text|json>`
- **Service Method**: `usersService.updateUser(id, updateData)`
- **JSON Output**: Full updated user object

#### `users delete`
- **Purpose**: Delete a user
- **Required Args**: `--id <uuid>`
- **Options**: `--force <true|false>`, `--format <text|json>`
- **Service Method**: `usersService.deleteUser(id)`
- **JSON Output**: Deletion confirmation with deleted user info

### 2. Search Commands

#### `users search` (Future Enhancement)
- **Purpose**: Search users by query
- **Required Args**: `--query <string>`
- **Options**: `--format <text|json>`, `--limit <number>`
- **Service Method**: `usersService.searchUsers(query)`
- **JSON Output**: Array of matching user objects

## Implementation Patterns

### Command Structure Template
```typescript
export const command: ICLICommand = {
  description: 'Clear description of command purpose',
  options: [
    {
      name: 'format',
      alias: 'f',
      type: 'string',
      description: 'Output format',
      choices: ['text', 'json'],
      default: 'text'
    },
    // ... other options
  ],
  execute: async (context: ICLIContext): Promise<void> => {
    const cliOutput = CliOutputService.getInstance();
    const logger = LoggerService.getInstance();
    
    try {
      // 1. Validate arguments with Zod
      const validatedArgs = commandSchema.parse(context.args);
      
      // 2. Get UsersService instance
      const usersService = UsersService.getInstance();
      
      // 3. Execute operation through service
      const result = await usersService.methodName(validatedArgs);
      
      // 4. Output based on format
      if (validatedArgs.format === 'json') {
        cliOutput.json(result);
      } else {
        // Human-readable output
        cliOutput.section('Operation Result');
        cliOutput.keyValue({
          'Field': result.value,
          // ... other fields
        });
      }
      
      process.exit(0);
    } catch (error) {
      // Proper error handling
      if (error instanceof z.ZodError) {
        cliOutput.error('Invalid arguments:');
        error.errors.forEach(err => {
          cliOutput.error(`  ${err.path.join('.')}: ${err.message}`);
        });
      } else {
        cliOutput.error('Command failed');
        logger.error(LogSource.USERS, 'CLI command error', { error });
      }
      process.exit(1);
    }
  }
};
```

### Validation Utilities
```typescript
// users/utils/cli-validation.ts
import { z } from 'zod';
import { UserCreateDataSchema, UserUpdateDataSchema } from '../types/users.module.generated';
import { UsersStatusSchema } from '../types/database.generated';

export const cliSchemas = {
  create: UserCreateDataSchema.extend({
    format: z.enum(['text', 'json']).default('text'),
    emailVerified: z.enum(['true', 'false'])
      .transform(v => v === 'true')
      .optional()
      .default('false')
  }).transform(data => ({
    ...data,
    email_verified: data.emailVerified
  })),
  
  update: z.object({
    id: z.string().uuid('Invalid user ID format'),
    format: z.enum(['text', 'json']).default('text'),
    // All update fields are optional
    username: z.string().optional(),
    email: z.string().email().optional(),
    display_name: z.string().nullable().optional(),
    avatar_url: z.string().url().nullable().optional(),
    bio: z.string().nullable().optional(),
    timezone: z.string().nullable().optional(),
    language: z.string().nullable().optional(),
    status: UsersStatusSchema.optional(),
    email_verified: z.enum(['true', 'false'])
      .transform(v => v === 'true')
      .optional()
  }).refine(data => {
    const updateFields = Object.keys(data).filter(key => 
      key !== 'id' && key !== 'format' && data[key] !== undefined
    );
    return updateFields.length > 0;
  }, {
    message: 'At least one field must be provided for update'
  }),
  
  list: z.object({
    format: z.enum(['text', 'json']).default('text'),
    status: UsersStatusSchema.optional(),
    limit: z.coerce.number().positive().max(100).default(20),
    page: z.coerce.number().positive().default(1)
  }),
  
  get: z.object({
    format: z.enum(['text', 'json']).default('text'),
    id: z.string().uuid().optional(),
    username: z.string().optional()
  }).refine(data => data.id || data.username, {
    message: 'Either id or username must be provided'
  }),
  
  delete: z.object({
    id: z.string().uuid('Invalid user ID format'),
    force: z.enum(['true', 'false'])
      .transform(v => v === 'true')
      .default('false'),
    format: z.enum(['text', 'json']).default('text')
  })
};
```

## Service Integration Requirements

### UsersService Methods Available
The CLI commands use these UsersService methods:

**Available Methods**:
- `createUser(data: IUserCreateData)` - Create new user
- `getUser(id: string)` - Get user by ID
- `getUserByUsername(username: string)` - Get user by username
- `getUserByEmail(email: string)` - Get user by email
- `listUsers()` - List all users
- `updateUser(id: string, data: IUserUpdateData)` - Update user
- `deleteUser(id: string)` - Delete user
- `searchUsers(query: string)` - Search users (for future enhancement)

## Integration Test Requirements

All CLI commands MUST have integration tests in:
`/tests/integration/modules/core/users/cli/{command}.integration.test.ts`

### Test Coverage Requirements
1. **Success Scenarios**: Valid arguments, proper JSON output
2. **Validation Errors**: Invalid arguments, missing required fields
3. **Service Errors**: User not found, database errors
4. **Format Support**: Both text and JSON output modes
5. **Exit Codes**: Verify proper exit codes for success/failure

### Test Template
```typescript
import { runCLICommand } from '@/tests/utils/cli-runner';
import { UsersRowSchema } from '@/modules/core/users/types/database.generated';

describe('users {command} CLI command', () => {
  describe('Execution', () => {
    it('should execute successfully with valid arguments', async () => {
      const { stdout, stderr, exitCode } = await runCLICommand(
        'users', 
        '{command}', 
        ['--required-arg', 'value', '--format', 'json']
      );
      
      expect(exitCode).toBe(0);
      expect(stderr).toBe('');
      
      const output = JSON.parse(stdout);
      expect(() => UsersRowSchema.parse(output)).not.toThrow();
    });
    
    it('should return proper JSON format', async () => {
      const { stdout } = await runCLICommand(
        'users', 
        '{command}', 
        ['--valid-args', '--format', 'json']
      );
      
      expect(() => JSON.parse(stdout)).not.toThrow();
    });
    
    it('should handle validation errors', async () => {
      const { stderr, exitCode } = await runCLICommand(
        'users', 
        '{command}', 
        ['--invalid-arg', 'value']
      );
      
      expect(exitCode).toBe(1);
      expect(stderr).toContain('Invalid arguments');
    });
  });
});
```

## Module Boundary Enforcement

The users CLI implementation MUST respect module boundaries:

1. **ONLY use exported UsersService** - No direct access to internal services
2. **Event-based communication** - For inter-module interactions
3. **No circular dependencies** - Clean module isolation
4. **Proper error boundaries** - Graceful handling of service failures

## Quality Standards

1. **Professional Output**: Clean, consistent formatting without decorative elements
2. **Machine Readable**: JSON output must be parseable and structured
3. **User Friendly**: Clear error messages and helpful validation feedback
4. **Performance**: Efficient service method calls, minimal overhead
5. **Security**: Proper input validation, no sensitive data leakage in output

## Future Enhancements

1. **Advanced Search**: Full-text searching with multiple criteria
2. **Bulk Operations**: Batch user creation and updates
3. **Export/Import**: User data backup and restore commands
4. **Interactive Mode**: Multi-step user creation flows
5. **User Statistics**: Detailed analytics commands