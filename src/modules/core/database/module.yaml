name: database
version: 1.0.0
description: Core database module for SystemPrompt OS
author: SystemPrompt OS Team <team@systemprompt-os.com>
type: core
enabled: true

dependencies: []

configuration:
  # Database type: sqlite | postgres
  type: ${DATABASE_TYPE:-sqlite}
  
  # SQLite configuration
  sqlite:
    filename: ${DATABASE_FILE:-/data/state/systemprompt.db}
    mode: ${SQLITE_MODE:-wal}  # wal | journal
    
  # PostgreSQL configuration (for future use)
  postgres:
    host: ${POSTGRES_HOST:-localhost}
    port: ${POSTGRES_PORT:-5432}
    database: ${POSTGRES_DB:-systemprompt}
    user: ${POSTGRES_USER:-systemprompt}
    password: ${POSTGRES_PASSWORD}
    ssl: ${POSTGRES_SSL:-false}
    
  # Connection pool settings
  pool:
    min: ${DB_POOL_MIN:-1}
    max: ${DB_POOL_MAX:-10}
    idle_timeout: ${DB_IDLE_TIMEOUT:-30000}
    
  # Migration settings
  migrations:
    auto_run: ${DB_AUTO_MIGRATE:-true}
    directory: database/migrations
    
  # Schema discovery
  schema:
    scan_pattern: "*/database/schema.sql"
    init_pattern: "*/database/init.sql"

exports:
  - services
  - adapters
  - types

cli:
  commands:
    - name: status
      description: Show database connection status and information
    - name: summary
      description: Show formatted summary of database tables and statistics
      options:
        - name: format
          alias: f
          type: string
          description: Output format (text, json, table)
          default: table
        - name: include-system
          alias: s
          type: boolean
          description: Include system tables in summary
          default: false
        - name: sort-by
          type: string
          description: Sort tables by (name, rows, columns)
          default: name
    - name: view
      description: View table contents and data
      options:
        - name: table
          type: string
          description: Name of the table to view
          required: true
        - name: format
          alias: f
          type: string
          description: Output format (table, json, csv)
          default: table
        - name: limit
          alias: l
          type: number
          description: Limit number of rows displayed
          default: 50
        - name: offset
          alias: o
          type: number
          description: Skip number of rows (for pagination)
          default: 0
        - name: columns
          alias: c
          type: string
          description: Comma-separated list of columns to display (default all)
        - name: where
          alias: w
          type: string
          description: WHERE clause condition
        - name: order-by
          type: string
          description: ORDER BY clause
        - name: schema-only
          alias: s
          type: boolean
          description: Show only table schema, not data
          default: false
    - name: clear
      description: Clear all data from database tables (preserves schema)
      options:
        - name: force
          type: boolean
          description: Skip confirmation prompts (dangerous!)
          default: false
        - name: confirm
          type: boolean
          description: Confirm you understand the risks
          default: false
    - name: rebuild
      description: Rebuild database - drop all tables and recreate from schema files
      options:
        - name: force
          type: boolean
          description: Skip confirmation prompts (extremely dangerous!)
          default: false
        - name: confirm
          type: boolean
          description: Confirm you understand the risks
          default: false
    - name: migrate
      description: Run pending database migrations
      options:
        - name: dry-run
          type: boolean
          description: Preview migrations without running them
        - name: module
          type: string
          description: Run migrations for a specific module only
    - name: rollback
      description: Rollback database migrations
      options:
        - name: steps
          type: number
          description: Number of migrations to rollback
          default: 1
        - name: module
          type: string
          description: Rollback migrations for a specific module only
        - name: force
          type: boolean
          description: Force rollback without confirmation
    - name: schema
      description: Manage database schemas
      options:
        - name: action
          type: string
          description: Action to perform (list, init, validate)
          required: true
        - name: module
          type: string
          description: Module name (for init action)
        - name: force
          type: boolean
          description: Force initialization even if already initialized
    - name: query
      description: Execute SQL queries safely (admin only)
      options:
        - name: sql
          type: string
          description: SQL query to execute
        - name: file
          type: string
          description: File containing SQL queries
        - name: format
          type: string
          description: Output format (table, json, csv)
          default: table
        - name: interactive
          type: boolean
          description: Start interactive SQL shell
        - name: readonly
          type: boolean
          description: Allow only SELECT queries (safe mode)
          default: true
    - name: data:export
      description: Export database data
      options:
        - name: tables
          alias: t
          type: string
          description: Comma-separated list of tables to export (default all)
        - name: format
          alias: f
          type: string
          description: Export format (sql, json, csv)
          default: sql
        - name: output
          alias: o
          type: string
          description: Output file path
          default: ./backup/export.sql
        - name: compress
          alias: c
          type: boolean
          description: Compress output with gzip
          default: false
    - name: data:import
      description: Import data from backup
      options:
        - name: file
          alias: f
          type: string
          description: Input file path
          required: true
        - name: type
          alias: t
          type: string
          description: Import type (sql, json)
          default: sql
        - name: dry-run
          type: boolean
          description: Validate import without executing
          default: false
        - name: force
          type: boolean
          description: Force import even if data exists
          default: false
    - name: data:backup
      description: Create database backup
      options:
        - name: dir
          alias: d
          type: string
          description: Backup directory
          default: ./backup
        - name: name
          alias: n
          type: string
          description: Backup name (default timestamp)
        - name: compress
          alias: c
          type: boolean
          description: Compress backup with gzip
          default: true
        - name: include-logs
          type: boolean
          description: Include log tables in backup
          default: false
    - name: data:restore
      description: Restore database from backup
      options:
        - name: file
          alias: f
          type: string
          description: Backup file path
          required: true
        - name: verify
          type: boolean
          description: Verify backup before restore
          default: true
        - name: force
          type: boolean
          description: Force restore without confirmation
          default: false
    - name: data:validate
      description: Validate data integrity
      options:
        - name: tables
          alias: t
          type: string
          description: Comma-separated list of tables to validate (default all)
        - name: fix
          type: boolean
          description: Attempt to fix issues found
          default: false
        - name: check-orphans
          type: boolean
          description: Check for orphaned records
          default: true
    - name: data:clean
      description: Clean old/unused data
      options:
        - name: dry-run
          type: boolean
          description: Show what would be cleaned without doing it
          default: false
        - name: all
          type: boolean
          description: Clean all types of data
          default: false
        - name: age
          type: string
          description: Clean data older than N days
          default: "30"
        - name: vacuum
          type: boolean
          description: Run VACUUM after cleaning
          default: true
    - name: data:migrate
      description: Migrate data between versions
      options:
        - name: from
          type: string
          description: Source version
          required: true
        - name: to
          type: string
          description: Target version
          required: true
        - name: dry-run
          type: boolean
          description: Preview migration without executing
          default: false
        - name: backup
          type: boolean
          description: Create backup before migration
          default: true