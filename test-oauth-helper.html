<!DOCTYPE html>
<html>
<head>
    <title>MCP OAuth Test Helper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #005a9e;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        #result {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MCP OAuth Flow Test Helper</h1>
        
        <div class="section">
            <h2>1. Current State</h2>
            <p>You received a 401 response with OAuth2 configuration:</p>
            <pre>{
  "authorization_uri": "http://localhost:3000/oauth2/authorize",
  "token_uri": "http://localhost:3000/oauth2/token",
  "scopes_supported": ["openid", "email", "profile"]
}</pre>
        </div>

        <div class="section">
            <h2>2. Test Without Auth</h2>
            <p>Click to test MCP endpoint without authentication:</p>
            <button onclick="testWithoutAuth()">Test MCP Endpoint</button>
            <div id="noAuthResult"></div>
        </div>

        <div class="section">
            <h2>3. Generate Test Token</h2>
            <p>Since OAuth providers aren't configured, let's create a test token:</p>
            <button onclick="generateTestToken()">Generate Test Token</button>
            <div id="tokenResult"></div>
        </div>

        <div class="section">
            <h2>4. Test With Auth</h2>
            <p>Once you have a token, test the MCP endpoint with authentication:</p>
            <button onclick="testWithAuth()" id="testAuthBtn" disabled>Test with Token</button>
            <div id="authResult"></div>
        </div>

        <div class="section">
            <h2>5. Try Real OAuth Flow</h2>
            <p>To see the provider selection page:</p>
            <a href="http://localhost:3000/oauth2/authorize?response_type=code&client_id=test-client&redirect_uri=http://localhost:3000/callback&scope=openid%20email%20profile&state=test123" 
               target="_blank">
                <button type="button">Start OAuth Flow</button>
            </a>
        </div>
    </div>

    <script>
        let testToken = null;

        async function testWithoutAuth() {
            try {
                const response = await fetch('http://localhost:3000/mcp/core', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'capabilities',
                        id: 1
                    })
                });
                
                const data = await response.json();
                document.getElementById('noAuthResult').innerHTML = 
                    `<pre>Status: ${response.status}\n${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('noAuthResult').innerHTML = 
                    `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function generateTestToken() {
            // In a real scenario, this would go through the OAuth flow
            // For testing, we'll create a mock JWT
            const header = btoa(JSON.stringify({alg: 'HS256', typ: 'JWT'}));
            const payload = btoa(JSON.stringify({
                sub: 'test-user',
                clientid: 'test-client',
                scope: 'openid email profile',
                iss: 'systemprompt-os',
                aud: 'systemprompt-os-clients',
                tokentype: 'access',
                exp: Math.floor(Date.now() / 1000) + 3600,
                iat: Math.floor(Date.now() / 1000)
            }));
            
            // Note: This is a test token - in production, this would be properly signed
            testToken = `${header}.${payload}.test-signature`;
            
            document.getElementById('tokenResult').innerHTML = 
                `<div class="success">Test token generated!</div>
                 <pre style="word-break: break-all;">Bearer ${testToken}</pre>
                 <p><small>Note: This test token won't work with the real server as it's not properly signed. 
                 To test with a real token, you need to configure OAuth providers.</small></p>`;
            
            document.getElementById('testAuthBtn').disabled = false;
        }

        async function testWithAuth() {
            if (!testToken) {
                alert('Please generate a test token first');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/mcp/core', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${testToken}`
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'capabilities',
                        id: 2
                    })
                });
                
                const data = await response.json();
                document.getElementById('authResult').innerHTML = 
                    `<pre>Status: ${response.status}\n${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('authResult').innerHTML = 
                    `<p class="error">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>