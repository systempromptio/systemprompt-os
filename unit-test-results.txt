
> @systemprompt/os@0.1.0 test:unit
> vitest run tests/unit


 RUN  v2.1.9 /var/www/html/systemprompt-os

 ✓ tests/unit/modules/core/auth/providers/core/oauth2.spec.ts (13 tests) 10ms
 ✓ tests/unit/server/external/rest/login.spec.ts (20 tests) 13ms
 ✓ tests/unit/modules/core/auth/providers/core/google.spec.ts (14 tests) 11ms
 ✓ tests/unit/server/mcp/core/handlers/prompt-handlers.spec.ts (9 tests) 28ms
 ❯ tests/unit/modules/core/auth/providers/core/github.spec.ts (11 tests | 1 failed) 15ms
   × GitHubProvider > getUserInfo > returns undefined email if no primary and no public email 6ms
     → expected undefined to be true // Object.is equality
 ✓ tests/unit/modules/core/config/cli/provider.spec.ts (20 tests) 18ms
 ✓ tests/unit/server/mcp/core/handlers/notifications.spec.ts (18 tests) 19ms
 ✓ tests/unit/modules/core/extension/cli/info.spec.ts (9 tests) 20ms
 ✓ tests/unit/modules/core/logger/logger.spec.ts (12 tests) 18ms
 ✓ tests/unit/modules/core/extension/cli/list.spec.ts (9 tests) 13ms
 ✓ tests/unit/utils/json-schema-to-zod.spec.ts (18 tests) 15ms
 ✓ tests/unit/modules/core/extension/cli/validate.spec.ts (8 tests) 13ms
 ✓ tests/unit/server/external/middleware/auth.spec.ts (9 tests) 10ms
 ✓ tests/unit/modules/core/config/cli/model.spec.ts (17 tests) 26ms
 ✓ tests/unit/modules/core/auth/cli/tunnel.spec.ts (7 tests) 13ms
 ✓ tests/unit/server/external/rest/oauth2/well-known.spec.ts (8 tests) 23ms
 ✓ tests/unit/modules/core/config/cli/validate.spec.ts (11 tests) 43ms
 ✓ tests/unit/modules/core/auth/services/tunnel-service.spec.ts (9 tests) 33ms
 ❯ tests/unit/server/external/rest/setup.spec.ts (19 tests | 2 failed) 55ms
   × SetupEndpoint > HTML rendering > should include security information in rendered pages 18ms
     → expected '\n      <!DOCTYPE html>\n      <html …' to contain 'The first user registered becomes the…'
   × SetupEndpoint > HTML rendering > should render status indicators correctly 9ms
     → expected '\n      <!DOCTYPE html>\n      <html …' to contain 'Database initialized'
 ❯ tests/unit/server/external/rest/register.spec.ts (22 tests | 1 failed) 32ms
   × OAuth2 Client Registration (RegisterEndpoint) > static methods > should validate client credentials correctly 8ms
     → expected false to be true // Object.is equality
 ✓ tests/unit/modules/core/auth/utils/generate-key.spec.ts (7 tests) 11ms
 ✓ tests/unit/utils/logger.spec.ts (14 tests) 197ms
 ✓ tests/unit/server/mcp/registry.spec.ts (21 tests) 75ms
 ✓ tests/unit/server/mcp/core/handlers/tools/utils/validation.spec.ts (19 tests) 18ms
 ✓ tests/unit/server/mcp/core/handlers/tool-handlers.spec.ts (15 tests) 43ms
 ✓ tests/unit/server/middleware.spec.ts (15 tests) 317ms
 ✓ tests/unit/cli/src/discovery.spec.ts (14 tests) 230ms
 ✓ tests/unit/modules/core/extension/cli/install.spec.ts (6 tests) 8ms
 ✓ tests/unit/modules/core/auth/cli/providers.spec.ts (6 tests) 8ms
 ✓ tests/unit/server/external/rest/oauth2/userinfo.spec.ts (9 tests) 8ms
 ✓ tests/unit/modules/core/extension/cli/remove.spec.ts (6 tests) 8ms
 ✓ tests/unit/modules/core/heartbeat/cli/status.spec.ts (9 tests) 14ms
 ✓ tests/unit/modules/core/cli/cli.spec.ts (9 tests) 17ms
 ✓ tests/unit/modules/core/auth/cli/generatekey.spec.ts (7 tests) 15ms
 ✓ tests/unit/modules/core/heartbeat/heartbeat.spec.ts (8 tests) 25ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/react-components.spec.ts (7 tests) 8ms
 ✓ tests/unit/modules/core/cli/cli/list.spec.ts (7 tests) 11ms
 ✓ tests/unit/modules/core/extension/extension.spec.ts (9 tests) 10ms
 ✓ tests/unit/modules/core/cli/cli/docs.spec.ts (6 tests) 15ms
 ✓ tests/unit/modules/core/config/config.spec.ts (10 tests) 13ms
 ✓ tests/unit/modules/core/config/cli/list.spec.ts (8 tests) 11ms
 ✓ tests/unit/modules/core/config/cli/set.spec.ts (11 tests) 13ms
 ✓ tests/unit/server/mcp/loader.spec.ts (7 tests) 14ms
 ✓ tests/unit/modules/core/config/providers/google.spec.ts (12 tests) 15ms
 ✓ tests/unit/modules/core/heartbeat/cli/reset.spec.ts (6 tests) 13ms
 ✓ tests/unit/modules/core/cli/cli/help.spec.ts (5 tests) 11ms
 ✓ tests/unit/utils/id-validation.spec.ts (41 tests) 13ms
 ✓ tests/unit/server/external/rest/health.spec.ts (5 tests) 17ms
 ✓ tests/unit/server/config.spec.ts (11 tests) 194ms
 ✓ tests/unit/modules/registry.spec.ts (10 tests) 14ms
 ✓ tests/unit/server/external/rest/oauth2/authorize.spec.ts (14 tests) 31ms
 ❯ tests/unit/server/external/rest/oauth2/token.spec.ts (10 tests | 4 failed) 41ms
   × OAuth2 Token Endpoint - Optimized > authorization_code grant > exchanges valid authorization code for tokens 18ms
     → expected "spy" to be called with arguments: [ { access_token: Any<String>, …(4) } ]

Received: 

  1st spy call:

  Array [
    Object {
-     "access_token": Any<String>,
-     "expires_in": 3600,
-     "refresh_token": StringMatching /^[A-Za-z0-9_-]+$/,
-     "scope": "read write",
-     "token_type": "Bearer",
+     "error": "server_error",
+     "error_description": "Internal server error",
    },
  ]


Number of calls: 1

   × OAuth2 Token Endpoint - Optimized > PKCE Flow > handles 'valid PKCE verification' 6ms
     → expected "spy" to be called with arguments: [ ObjectContaining{…} ]

Received: 

  1st spy call:

  Array [
-   ObjectContaining {
-     "access_token": Any<String>,
+   Object {
+     "error": "server_error",
+     "error_description": "Internal server error",
    },
  ]


Number of calls: 1

   × OAuth2 Token Endpoint - Optimized > Authorization Code OAuth flow > completes full flow successfully 5ms
     → expected { error: 'server_error', …(1) } to match object { access_token: Any<String>, …(4) }
(2 matching properties omitted from actual)
   × OAuth2 Token Endpoint - Optimized > Token Structure > generates valid JWT structure for access tokens 2ms
     → The first argument must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object. Received undefined
 ✓ tests/unit/modules/loader.spec.ts (11 tests) 162ms
 ❯ tests/unit/server/mcp/core/server.spec.ts (7 tests | 1 failed) 15ms
   × MCPServer > session management > should clean up old sessions 6ms
     → server.cleanupOldSessions is not a function
 ✓ tests/unit/server/mcp/core/utils/task-helpers.spec.ts (9 tests) 11ms
 ✓ tests/unit/modules/core/auth/tunnel-status.spec.ts (10 tests) 9ms
 ✓ tests/unit/server/external/auth/jwt.spec.ts (7 tests) 11ms
 ✓ tests/unit/server/mcp/core/permissions.spec.ts (7 tests) 5ms
 ✓ tests/unit/server/mcp.spec.ts (3 tests) 38ms
 ✓ tests/unit/server/mcp/core/handlers/resource-handlers.spec.ts (9 tests) 6ms
 ✓ tests/unit/server/mcp/core/handlers/resources/task-output.spec.ts (8 tests) 11ms
 ✓ tests/unit/modules/core/config/cli/get.spec.ts (8 tests) 9ms
 ✓ tests/unit/cli/src/index.spec.ts (7 tests) 543ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/unit-testing.spec.ts (7 tests) 7ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/bug-fixing.spec.ts (6 tests) 7ms
 ✓ tests/unit/server/mcp/core/constants/prompts.spec.ts (8 tests) 9ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/index.spec.ts (10 tests) 10ms
 ✓ tests/unit/server/mcp/core/handlers/prompts/reddit-post.spec.ts (7 tests) 8ms
 ✓ tests/unit/server/mcp-handler.spec.ts (18 tests) 45ms
 ✓ tests/unit/modules/core/auth/services/tunnel-service.simple.spec.ts (6 tests) 8ms
 ✓ tests/unit/server/mcp/core/constants/resources.spec.ts (9 tests) 7ms
 ✓ tests/unit/server/mcp/core/constants/task-status.spec.ts (10 tests) 9ms
 ✓ tests/unit/server/mcp/core/constants/tool/check-status.spec.ts (6 tests) 7ms
 ✓ tests/unit/server/external/auth/providers/generic-oauth2.spec.ts (10 tests) 12ms
 ✓ tests/unit/server/external/auth/providers/github.spec.ts (7 tests) 14ms
 ✓ tests/unit/index.spec.ts (4 tests) 124ms
 ✓ tests/unit/server/mcp/core/constants/tools.spec.ts (2 tests) 5ms
 ✓ tests/unit/server/external/auth/providers/google.spec.ts (6 tests) 13ms
 ✓ tests/unit/modules/core/auth/auth.spec.ts (6 tests) 11ms
 ✓ tests/unit/server/external/rest/status.spec.ts (2 tests) 7ms
 ✓ tests/unit/server/index.spec.ts (12 tests) 1258ms
   ✓ Server > createApp > should create and configure Express app 702ms
 ✓ tests/unit/tools/generate-key/generate-key.spec.ts (6 tests) 2108ms
   ✓ CLI Key Generation > JWK format generation > should generate keys in JWK format with correct structure 451ms
   ✓ CLI Key Generation > JWK format generation > should support RS512 algorithm 1103ms

 Test Files  5 failed | 77 passed (82)
      Tests  9 failed | 826 passed (835)
   Start at  16:34:02
   Duration  3.39s (transform 11.26s, setup 2.57s, collect 20.05s, tests 6.35s, environment 17ms, prepare 7.02s)

